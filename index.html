<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>FARESTA ‚Äî Laporan Tumbuh Kembang</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
<style>
:root{
  --primary: #4f46e5; /* Tailwind indigo-600 */
  --primary-light: #6366f1; /* Tailwind indigo-500 */
  --primary-bg: #eef2ff; /* Tailwind indigo-50 */
  --muted: #6b7280;
  --card: #fff;
  --bg: #f3f4f6; /* Lighter background */
  --shadow-sm: 0 1px 3px rgba(0,0,0,0.08);
  --shadow-md: 0 4px 6px rgba(0,0,0,0.1);
  --success: #10b981; /* Tailwind emerald-500 */
  --error: #ef4444; /* Tailwind red-500 */
  --warning: #f59e0b; /* Tailwind amber-500 */
}
*{box-sizing:border-box}
html,body{height:100%;margin:0;font-family:Inter,system-ui,-apple-system,'Segoe UI',Roboto,Arial;color:#1f2937;background:var(--bg)}

/* --- Sidebar --- */
#sidebarBtn{position:fixed;top:16px;left:16px;z-index:140;background:var(--primary);color:#fff;border:0;padding:10px;border-radius:12px;cursor:pointer;box-shadow:var(--shadow-md); transition: transform .3s ease;}
#sidebarBtn:hover{transform: scale(1.05);}
#sidebar{position:fixed;top:16px;left:16px;width:200px;background:var(--primary);border-radius:12px;padding:8px;box-shadow:0 10px 30px rgba(15,23,42,.15);transform:translateX(-250px);transition:transform .3s cubic-bezier(0.68, -0.55, 0.265, 1.55);z-index:130}
#sidebar.open{transform:translateX(0)}
#sidebar .panel{background:#fff;color:#1f2937;border-radius:10px;padding:10px;margin-top:8px;box-shadow:var(--shadow-sm)}
#sidebar h3{margin:0 0 6px;font-size:14px;color:#fff}
#sidebar a{display:flex;align-items:center;gap:8px;padding:10px;border-radius:8px;text-decoration:none;color:#1f2937;margin-bottom:6px;background:var(--primary-bg);font-weight:600;transition:background .15s ease}
#sidebar a:hover{background:#dbeafe}
#sidebar a.admin-only{display:none}
#overlay{position:fixed;inset:0;background:rgba(0,0,0,0.18);z-index:120;display:none;opacity:0;transition:opacity .3s ease}
#overlay.show{display:block;opacity:1}

/* --- Layout --- */
.container{
    max-width:1200px;
    margin:24px auto; 
    padding:16px;
}
.header{
    background:linear-gradient(135deg,var(--primary),var(--primary-light));
    padding:28px;
    border-radius:16px;
    color:#fff; 
    display:flex;
    gap:20px;
    align-items:center;
    box-shadow:var(--shadow-md); 
    margin-bottom: 20px;
} 
.header .title{font-size:24px;font-weight:700}
.header .subtitle{opacity:.9;font-size:15px}
.row{display:grid;grid-template-columns:1fr 360px;gap:20px;margin-top:0} 
.card{
    background:var(--card);
    padding:20px; 
    border-radius:12px;
    box-shadow:var(--shadow-md);
    border: 1px solid #e5e7eb; 
}
.card h4 {
    font-size: 18px; 
    margin-top: 0;
    margin-bottom: 15px; 
    font-weight: 700;
}

/* --- Elements --- */
.field{margin-top:14px} 
label{display:block;margin-bottom:4px;font-weight:600;font-size:15px; color:#1f2937} 
input:not([type="file"]),textarea,select{
    width:100%;
    padding:10px 12px; 
    border-radius:8px; 
    border:1px solid #d1d5db;
    background:#fff;
    font-size:15px; 
    margin-bottom: 5px; 
    transition:border-color .2s ease
}
input:focus,textarea:focus,select:focus{border-color:var(--primary);outline:none}
button{background:var(--primary);color:#fff;padding:12px 18px;border-radius:8px;border:0;cursor:pointer;font-weight:600;transition:background .2s ease;font-size:15px;box-shadow:0 2px 4px rgba(0,0,0,0.1)} 
button:hover{background:var(--primary-light)}
button.ghost{background:transparent;color:var(--primary);border:1px solid var(--primary-bg);box-shadow:none}
button.ghost:hover{background:var(--primary-bg)}
.select-child {
    display: flex;
    gap: 10px;
    align-items: center;
    margin-bottom: 15px;
    padding: 10px;
    border: 1px solid var(--primary-bg);
    border-radius: 8px;
    background: var(--primary-bg);
}

/* --- Data Grid (Riwayat) --- */
.grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(180px,1fr));gap:14px} 
.card-grid{background:#fff;border-radius:10px;padding:10px;box-shadow:var(--shadow-sm);display:flex;flex-direction:column;align-items:stretch;border:1px solid #e5e7eb; cursor: pointer;} 
.card-grid img{
    width:100%;
    height:160px; 
    object-fit: contain; 
    border-radius:8px;
    margin-bottom:8px;
    background-color: #f8fafc; 
    border: 1px solid #f3f4f6;
}
.card-grid .info{padding:4px}
.card-grid strong{font-size:16px; color:#1f2937;} 
.card-grid .meta{color:var(--muted);font-size:14px;line-height:1.4} 
.data-small{font-size:14px;color:var(--muted)} 
.delete-btn {
    background: var(--error);
    color: white;
    padding: 8px 12px; 
    border-radius: 6px;
    font-size: 14px; 
    margin-top: 8px;
    width: 100%;
    transition: background .2s ease;
}
.delete-btn:hover { background: #cc3333; }
.btn-group {
    display: flex;
    gap: 8px;
    margin-top: 15px;
}

/* Status Gizi */
.status-badge {
    display: inline-block;
    padding: 4px 8px;
    border-radius: 4px;
    font-weight: 700;
    font-size: 12px;
    margin-top: 5px;
    margin-bottom: 10px;
    color: white;
}
.status-badge.normal { background: var(--success); }
.status-badge.underweight, .status-badge.overweight { background: var(--warning); }
.status-badge.severe { background: var(--error); }


/* Admin Dashboard styles */
.admin-stats {
    display: flex;
    gap: 16px; 
    margin-top: 16px;
}
.stat-box {
    flex: 1;
    padding: 16px; 
    border-radius: 10px;
    background: var(--primary-bg);
    border: 1px solid #e0e7ff;
    text-align: center;
}
.stat-box .count {
    font-size: 30px; 
    font-weight: 700;
    color: var(--primary);
}
.stat-box .label {
    font-size: 14px; 
    color: var(--muted);
    margin-top: 4px;
}

/* --- Modal --- */
.modal{position:fixed;left:50%;top:50%;transform:translate(-50%,-50%);z-index:200;background:#fff;padding:24px;border-radius:16px;box-shadow:0 20px 50px rgba(15,23,42,.25);width:360px;max-width:94vw;display:none;opacity:0;transition:opacity .3s ease, transform .3s ease}
.modal.open{display:block;opacity:1;transform:translate(-50%,-50%)}
.modal h4{margin:0 0 10px;font-size:18px}
.modal #loginBlock, .modal #registerBlock { display: flex; flex-direction: column; gap: 8px;} 
.modal-overlay {
    position: fixed;
    inset: 0;
    background: rgba(0, 0, 0, 0.5);
    z-index: 190;
    display: none;
}
.modal.open ~ .modal-overlay {
    display: block;
}

/* Modal Preview Gambar */
#imagePreviewModal {
    width: auto;
    max-width: 80vw;
    padding: 10px;
    background: rgba(0,0,0,0.85); 
}
#imagePreviewModal.open {
    display: flex;
    justify-content: center;
    align-items: center;
    inset: 0; 
    transform: none;
    top: 0;
    left: 0;
}
#imagePreviewModal img {
    max-width: 100%;
    max-height: 90vh;
    border-radius: 8px;
    object-fit: contain;
    background: #fff;
    padding: 5px;
}


/* --- Chart --- */
.chart-box{height:350px;margin-top:10px} 

/* --- Toast Notification --- */
#toastContainer{position:fixed;top:20px;right:20px;z-index:1000} 
.toast{background:var(--card);color:#333;padding:12px 18px;border-radius:8px;box-shadow:0 6px 16px rgba(0,0,0,0.15);margin-bottom:10px;display:flex;align-items:center;gap:12px;opacity:0;transform:translateX(100%);transition:opacity .3s ease, transform .3s ease}
.toast.show{opacity:1;transform:translateX(0)}
.toast .icon{font-size:20px;line-height:1;margin-top:-2px}
.toast .message{font-weight:600;font-size:15px} 

/* --- Responsive --- */
@media(max-width:980px){
  .row{grid-template-columns:1fr; gap: 16px;}
  .header{flex-direction:column;align-items:flex-start}
  .container{padding: 16px;} 
  .card{padding:18px;} 
  #sidebar{width:180px}
  #toastContainer{right:10px;top:10px}
  .admin-stats { flex-direction: column; }
}

/* Khusus input file agar tidak terlalu kecil di mobile */
input[type="file"] {
    font-size: 14px;
    padding: 8px 0;
}
</style>
</head>
<body>

<button id="sidebarBtn" title="Menu">
    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
        <path d="M4 6H20M4 12H20M4 18H20" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
    </svg>
</button>
<div id="sidebar" aria-hidden="true">
  <div style="display:flex;align-items:center;gap:10px;padding:8px 10px;color:#fff;font-size:18px">
    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M12 2C6.477 2 2 6.477 2 12C2 17.523 6.477 22 12 22C17.523 22 22 17.523 22 12C22 6.477 17.523 2 12 2Z" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><path d="M12 16C14.2091 16 16 14.2091 16 12C16 9.79086 14.2091 8 12 8C9.79086 8 8 9.79086 8 12C8 14.2091 9.79086 16 12 16Z" fill="white" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
    <div style="font-weight:700">FARESTA</div>
  </div>
  <div class="panel" id="sidebarPanel" style="display:none">
    <a href="#home" data-nav>üè° Beranda</a>
    <a href="#" id="openAuth" class="menu-login">üîë Login / Register</a>
    <a href="#dashboard" data-nav id="adminLink" class="admin-only">‚öôÔ∏è Dashboard Admin</a>
    <a href="#about" data-nav>üí° Tentang</a>
    <a href="#" id="btnLogout" style="display:none">üö™ Logout</a>
  </div>
</div>
<div id="overlay"></div>

<div id="toastContainer"></div>

<div class="container">
  <div class="header">
    <svg width="40" height="40" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12C2 6.47715 6.47715 2 12 2Z" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><path d="M12 16C14.2091 16 16 14.2091 16 12C16 9.79086 14.2091 8 12 8C9.79086 8 8 9.79086 8 12C8 14.2091 9.79086 16 12 16Z" fill="white" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
    <div>
      <div class="title">FARESTA ‚Äî Laporan Tumbuh Kembang</div>
      <div class="subtitle">Pantau perkembangan anak dengan mudah, simpan foto & grafik interaktif.</div>
    </div>
    <div style="margin-left:auto; text-align:right" id="accountArea"></div>
  </div>

  <div class="row">
    <main id="mainContent">
      <div class="card admin-only" id="adminDashboard" style="display:none; margin-bottom: 20px;">
        <h4>üìä Dashboard Admin</h4>
        <div class="admin-stats">
            <div class="stat-box">
                <div class="count" id="statUsers">0</div>
                <div class="label">Total User Terdaftar</div>
            </div>
            <div class="stat-box">
                <div class="count" id="statVisits">0</div>
                <div class="label">Total Kunjungan Website</div>
            </div>
        </div>
      </div>
      
      <div class="card" id="inputSection">
        <h4>Input Data Perkembangan Anak</h4>
        <div class="data-small" id="whoInfo">Belum login</div>

        <div id="childSelectorArea" class="select-child" style="display:none;">
            <label for="childSelect" style="margin:0; font-weight: 700;">Pilih Anak:</label>
            <select id="childSelect" style="flex-grow:1; margin-bottom: 0;"></select>
            <button id="btnManageChildren" class="ghost" style="padding: 8px 12px; font-size: 14px;">üë∂ Atur Anak</button>
        </div>

        <div class="field"><label for="tinggi">Tinggi (cm)</label><input id="tinggi" placeholder="Cth: 80.5" type="number" min="0" step="0.1" /></div>
        <div class="field"><label for="berat">Berat (kg)</label><input id="berat" placeholder="Cth: 10.2" type="number" min="0" step="0.1" /></div>
        <div class="field"><label for="catatan">Catatan Perkembangan</label><textarea id="catatan" placeholder="Cth: Sudah bisa berjalan tanpa pegangan..."></textarea></div>
        <div class="field" style="display:flex;gap:10px;align-items:center"><input id="foto" type="file" accept="image/*" style="flex-grow:1" /><button id="btnSave">üíæ Simpan Data</button></div>
      </div>

      <div class="card" id="chartCard" style="margin-top:20px">
        <h4>üìà Grafik Pertumbuhan Anak</h4>
        <div id="growthStatus" class="status-badge">Data Tidak Lengkap</div>
        <div class="chart-box"><canvas id="growthChart" aria-label="Grafik pertumbuhan" role="img"></canvas></div>
        <div class="btn-group">
            <button id="btnExportCSV">üì• Ekspor Data (CSV)</button>
            <button id="btnExportPDF" class="ghost" disabled title="Fitur Proyeksi">üñ®Ô∏è Ekspor PDF (Coming Soon)</button>
        </div>
      </div>

      <div class="card" id="about" style="margin-top:20px">
        <h4>üí° Tentang FARESTA</h4>
        <p style="line-height:1.6; font-size: 15px;">FARESTA membantu orang tua menyimpan catatan tumbuh kembang anak, melihat grafik perkembangan, dan menyimpan foto untuk setiap catatan. Data disimpan secara lokal di browser Anda (LocalStorage) sehingga aman dan cepat.</p>
      </div>
    </main>

    <aside id="asideContent">
      <div class="card" id="authCard">
        <h4>Data Tersimpan (Riwayat)</h4>
        <div id="dataList" class="grid"></div>
      </div>
    </aside>
  </div>
</div>

<div id="authModal" class="modal" aria-hidden="true">
  <h4 id="authTitle">Login</h4>
  <div id="loginBlock">
    <input id="loginUser" placeholder="Username">
    <input id="loginPass" placeholder="Password" type="password">
    <div style="display:flex;gap:8px;margin-top:8px"><button id="btnLogin" style="flex-grow:1">Login</button><button id="showRegister" class="ghost">Register</button></div>
  </div>
  <div id="registerBlock" style="display:none">
    <input id="regUser" placeholder="Username">
    <input id="regPass" placeholder="Password" type="password">
    <div style="display:flex;gap:8px;margin-top:8px"><button id="btnRegister" style="flex-grow:1">Buat Akun</button><button id="showLogin" class="ghost">Kembali</button></div>
  </div>
</div>

<div id="manageChildModal" class="modal" aria-hidden="true">
    <h4>üë∂ Atur Anak</h4>
    <div id="childListManagement" style="max-height: 200px; overflow-y: auto; margin-bottom: 15px;">
        </div>
    <hr style="border: 0; border-top: 1px solid #e5e7eb;">
    <h5 style="margin-top: 15px; font-size: 16px; font-weight: 600;">Tambah Anak Baru</h5>
    <input id="newChildName" placeholder="Nama Anak">
    <div class="field"><label for="newChildDOB">Tanggal Lahir Anak</label><input id="newChildDOB" type="date"></div>
    <button id="btnAddChild">‚ûï Tambah Anak</button>
</div>

<div id="imagePreviewModal" class="modal" aria-hidden="true" onclick="closeImagePreview()">
    <img id="previewImage" src="" alt="Preview Gambar Riwayat">
</div>
<div class="modal-overlay"></div>


<script>
// --- GLOBAL CONSTANTS & HELPERS ---
const USERS_KEY = 'faresta_users_v3';
const VISIT_COUNT_KEY = 'faresta_visit_count_v1';
const SESSION_USER_KEY = 'faresta_session_user';
const SESSION_ROLE_KEY = 'faresta_session_role';
const SESSION_CHILD_KEY = 'faresta_session_child_id'; // KUNCI BARU: ID anak yang aktif

const getUsers = ()=> JSON.parse(localStorage.getItem(USERS_KEY) || '{}');
const saveUsers = u=> localStorage.setItem(USERS_KEY, JSON.stringify(u));

let currentUser = null; 
let currentRole = null; 
let currentChildId = null; // ID Anak yang sedang aktif

// --- WHO GROWTH CHART DATA SIMULATED (Simplified) ---
// Untuk demonstrasi, kita gunakan simulasi data WHO Z-Score Weight-for-Length/Height (WFL) untuk anak laki-laki usia 60-110 cm
// Z-Score: -3 (Severe Thinness), -2 (Thinness), +1 (Possible Risk of Overweight), +2 (Overweight), +3 (Obese)
// Data ini sangat disederhanakan dan harus diganti dengan data Z-Score WHO yang akurat dan lengkap.

const WHO_WFL_SIMULATION = {
    // Berat median (kg) pada panjang/tinggi tertentu (cm)
    '60': 5.8, // Example: 60cm median weight is 5.8kg
    '70': 8.0, 
    '80': 10.2,
    '90': 12.7,
    '100': 15.3,
    '110': 17.8
    // Dalam implementasi nyata, ini harus data Z-Score yang lengkap (-3SD hingga +3SD)
};

// --- SESSION MANAGEMENT FUNCTIONS ---
function saveSession(username, role, childId = null) {
    localStorage.setItem(SESSION_USER_KEY, username);
    localStorage.setItem(SESSION_ROLE_KEY, role);
    if (childId) {
        localStorage.setItem(SESSION_CHILD_KEY, childId);
    } else {
        localStorage.removeItem(SESSION_CHILD_KEY);
    }
}

function clearSession() {
    localStorage.removeItem(SESSION_USER_KEY);
    localStorage.removeItem(SESSION_ROLE_KEY);
    localStorage.removeItem(SESSION_CHILD_KEY);
}

function loadSession() {
    const user = localStorage.getItem(SESSION_USER_KEY);
    const role = localStorage.getItem(SESSION_ROLE_KEY);
    const childId = localStorage.getItem(SESSION_CHILD_KEY);

    if (user && role) {
        currentUser = user;
        currentRole = role;
        currentChildId = childId;
    }
}

// --- CHILD MANAGEMENT ---

function getCurrentChildData() {
    if (!currentUser || !currentChildId || currentRole === 'admin') return null;
    const users = getUsers();
    return users[currentUser]?.children?.[currentChildId] || null;
}

function renderChildSelector() {
    const childSelect = document.getElementById('childSelect');
    const childSelectorArea = document.getElementById('childSelectorArea');
    childSelect.innerHTML = '';
    
    if (!currentUser || currentRole === 'admin') {
        childSelectorArea.style.display = 'none';
        return;
    }

    const users = getUsers();
    const children = users[currentUser]?.children || {};
    const childKeys = Object.keys(children);

    if (childKeys.length === 0) {
        childSelectorArea.style.display = 'flex';
        childSelect.innerHTML = '<option value="">Silakan atur data anak</option>';
        currentChildId = null;
        saveSession(currentUser, currentRole, null);
    } else {
        childSelectorArea.style.display = 'flex';
        
        // Pilih anak pertama jika tidak ada sesi anak yang valid
        if (!currentChildId || !children[currentChildId]) {
            currentChildId = childKeys[0];
            saveSession(currentUser, currentRole, currentChildId);
        }

        childKeys.forEach(id => {
            const option = document.createElement('option');
            option.value = id;
            option.innerText = `${children[id].name} (${calculateAge(children[id].dob)} bulan)`;
            if (id === currentChildId) {
                option.selected = true;
            }
            childSelect.appendChild(option);
        });

        // Event listener for changing child
        childSelect.onchange = (e) => {
            currentChildId = e.target.value;
            saveSession(currentUser, currentRole, currentChildId);
            showToast(`Anak diubah ke: ${children[currentChildId].name}`, 'info');
            renderAllData(); // Reload all data based on new child
        };
    }
}

// --- MODAL MANAGEMENT ---
const manageChildModal = document.getElementById('manageChildModal');

document.getElementById('btnManageChildren').addEventListener('click', () => {
    if (!currentUser || currentRole === 'admin') return;
    renderChildManagementList();
    manageChildModal.classList.add('open');
});

document.getElementById('btnAddChild').addEventListener('click', () => {
    const name = document.getElementById('newChildName').value.trim();
    const dob = document.getElementById('newChildDOB').value;

    if (!name || !dob) {
        showToast('Nama dan Tanggal Lahir harus diisi.', 'error');
        return;
    }

    const users = getUsers();
    const newChildId = Date.now().toString();

    users[currentUser].children = users[currentUser].children || {};
    users[currentUser].children[newChildId] = {
        name: name,
        dob: dob,
        data: []
    };
    saveUsers(users);
    showToast(`${name} berhasil ditambahkan!`, 'success');

    // Set new child as active
    currentChildId = newChildId;
    saveSession(currentUser, currentRole, currentChildId);

    // Clear form and re-render
    document.getElementById('newChildName').value = '';
    document.getElementById('newChildDOB').value = '';
    renderAllData();
    renderChildManagementList();
    manageChildModal.classList.remove('open');
});

function renderChildManagementList() {
    const list = document.getElementById('childListManagement');
    list.innerHTML = '';
    const users = getUsers();
    const children = users[currentUser]?.children || {};

    Object.keys(children).forEach(id => {
        const child = children[id];
        const div = document.createElement('div');
        div.style.cssText = 'display:flex; justify-content:space-between; align-items:center; padding: 8px 0; border-bottom: 1px solid #eee;';
        div.innerHTML = `
            <span><strong>${child.name}</strong> (${child.dob})</span>
            <button onclick="deleteChild('${id}')" style="background: var(--error); padding: 5px 10px; font-size: 13px;">Hapus</button>
        `;
        list.appendChild(div);
    });
    if (Object.keys(children).length === 0) {
        list.innerHTML = '<div class="data-small">Belum ada data anak.</div>';
    }
}

function deleteChild(id) {
    if (!confirm('Yakin ingin menghapus data anak ini? Semua riwayat akan hilang!')) return;

    const users = getUsers();
    delete users[currentUser].children[id];
    saveUsers(users);
    showToast('Data anak berhasil dihapus.', 'success');

    // Update active child if the deleted one was active
    if (currentChildId === id) {
        currentChildId = Object.keys(users[currentUser].children || {})[0] || null;
        saveSession(currentUser, currentRole, currentChildId);
    }
    renderAllData();
    renderChildManagementList();
}


// --- WHO ANALYSIS (SIMPLIFIED) ---

function getGrowthStatus(height, weight, gender = 'male') { 
    // Data WHO WFL yang disimulasikan di sini hanya untuk demonstrasi.
    // Implementasi nyata memerlukan tabel data Z-Score lengkap.
    if (!height || !weight || height < 60 || height > 110) {
        return { status: 'Data Tidak Lengkap', class: '' };
    }

    // Mendapatkan median berat terdekat dari data simulasi
    const nearestHeight = Object.keys(WHO_WFL_SIMULATION)
        .map(Number)
        .reduce((prev, curr) => (Math.abs(curr - height) < Math.abs(prev - height) ? curr : prev));
        
    const medianWeight = WHO_WFL_SIMULATION[nearestHeight];

    let status = '';
    let statusClass = '';

    const difference = weight - medianWeight;

    if (difference < -2) {
        status = 'Gizi Kurang';
        statusClass = 'severe';
    } else if (difference < -1) {
        status = 'Risiko Gizi Kurang';
        statusClass = 'underweight';
    } else if (difference > 1.5) {
        status = 'Risiko Gizi Lebih';
        statusClass = 'overweight';
    } else if (difference > 2.5) {
        status = 'Obesitas';
        statusClass = 'severe';
    } else {
        status = 'Gizi Baik (Normal)';
        statusClass = 'normal';
    }

    return { status, class: statusClass, median: medianWeight, heightUsed: nearestHeight };
}


// --- VISIT COUNTER ---
function countVisit() {
    let count = parseInt(localStorage.getItem(VISIT_COUNT_KEY) || '0');
    count += 1;
    localStorage.setItem(VISIT_COUNT_KEY, count);
}

// --- INITIAL SETUP: Ensure Admin Exists ---
(function(){ 
    const u=getUsers(); 
    if(!u.admin){ 
        // Admin skema baru: menggunakan properti 'children' kosong
        u.admin={password:'admin123', children: {}}; 
        saveUsers(u); 
    }
    countVisit(); 
})();


// --- TOAST NOTIFICATION FUNCTION ---
function showToast(message, type = 'info') {
    const container = document.getElementById('toastContainer');
    const toast = document.createElement('div');
    toast.className = `toast ${type}`;
    let icon = '';
    if (type === 'success') icon = '‚úÖ';
    else if (type === 'error') icon = '‚ùå';
    else if (type === 'warning') icon = '‚ö†Ô∏è';
    else icon = 'üí°';
    
    toast.innerHTML = `<span class="icon">${icon}</span><span class="message">${message}</span>`;
    container.appendChild(toast);
    
    setTimeout(() => {
        toast.classList.add('show');
    }, 50);

    setTimeout(() => {
        toast.classList.remove('show');
        setTimeout(() => toast.remove(), 300); 
    }, 4000);
}

// --- MODAL & PREVIEW FUNCTIONS ---
const imagePreviewModal = document.getElementById('imagePreviewModal');
const previewImage = document.getElementById('previewImage');
const authModal = document.getElementById('authModal');
const modalOverlay = document.querySelector('.modal-overlay');

function openModal(modalEl) {
    modalEl.classList.add('open');
    modalEl.setAttribute('aria-hidden', 'false');
    modalOverlay.style.display = 'block';
}
function closeModal(modalEl) {
    modalEl.classList.remove('open');
    modalEl.setAttribute('aria-hidden', 'true');
    if (!authModal.classList.contains('open') && !manageChildModal.classList.contains('open')) {
        modalOverlay.style.display = 'none';
    }
}

function openImagePreview(src) {
    if (!src || src.includes('No Photo')) return; 
    previewImage.src = src;
    openModal(imagePreviewModal);
}

function closeImagePreview() {
    closeModal(imagePreviewModal);
    previewImage.src = ''; 
}
document.getElementById('overlay').addEventListener('click', ()=>{ closeSidebar(); closeModal(authModal); closeModal(imagePreviewModal); closeModal(manageChildModal); });

document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') {
        if(authModal.classList.contains('open')) closeModal(authModal);
        if(manageChildModal.classList.contains('open')) closeModal(manageChildModal);
        if(imagePreviewModal.classList.contains('open')) closeImagePreview();
        if(sidebar.classList.contains('open')) closeSidebar();
    }
});


// --- AGE CALCULATION FUNCTION ---
function calculateAge(birthDate) {
    if (!birthDate) return null;
    const today = new Date();
    const dob = new Date(birthDate);

    let months = (today.getFullYear() - dob.getFullYear()) * 12;
    months -= dob.getMonth();
    months += today.getMonth();

    if (today.getDate() < dob.getDate()) {
        months -= 1;
    }

    return months > 0 ? months : 0;
}

// --- DATA ACTIONS ---
function deleteEntry(id) {
    if (!currentUser || currentRole === 'admin' || !currentChildId) {
        showToast('Aksi ditolak. Silakan login sebagai pengguna dan pilih anak.', 'error');
        return;
    }
    
    const confirmation = confirm('Anda yakin ingin menghapus data ini? Aksi ini tidak dapat dibatalkan.');
    if (!confirmation) {
        return;
    }

    const users = getUsers();
    let data = users[currentUser].children[currentChildId].data || [];
    
    const initialLength = data.length;
    data = data.filter(entry => entry.id !== id);
    
    if (data.length === initialLength) {
        showToast('Data gagal ditemukan.', 'error');
        return;
    }

    users[currentUser].children[currentChildId].data = data;
    saveUsers(users);
    
    showToast('Data berhasil dihapus', 'success');
    renderList();
    renderChart();
}


// --- UI ELEMENTS ---
const sidebarBtn = document.getElementById('sidebarBtn');
const sidebar = document.getElementById('sidebar');
const sidebarPanel = document.getElementById('sidebarPanel');
const overlay = document.getElementById('overlay');
const authTitle = document.getElementById('authTitle');
const adminDashboard = document.getElementById('adminDashboard');
const inputSection = document.getElementById('inputSection');

// Sidebar open/close
function openSidebar(){ sidebar.classList.add('open'); sidebarPanel.style.display='block'; overlay.classList.add('show'); }
function closeSidebar(){ sidebar.classList.remove('open'); sidebarPanel.style.display='none'; overlay.classList.remove('show'); }

// open auth modal
function openAuth(mode='login'){ 
    authTitle.innerText = mode==='login' ? 'Login' : 'Register'; 
    openModal(authModal);
    document.getElementById('loginBlock').style.display=mode==='login' ? 'flex' : 'none'; 
    document.getElementById('registerBlock').style.display=mode==='register' ? 'flex' : 'none'; 
}


// --- ADMIN STATS ---
function getAdminStats() {
    const users = getUsers();
    const userCount = Object.keys(users).length; 
    const visitCount = parseInt(localStorage.getItem(VISIT_COUNT_KEY) || '0');
    return { userCount: userCount, visitCount: visitCount };
}

function renderAdminStats() {
    const stats = getAdminStats();
    document.getElementById('statUsers').innerText = stats.userCount;
    document.getElementById('statVisits').innerText = stats.visitCount;
}

// --- RENDER FUNCTIONS (MASTER) ---

function renderAllData() {
    renderChildSelector();
    renderAuth(); 
    renderWho(); 
    renderList(); 
    renderChart();
}

function renderAuth(){ 
  const accountArea = document.getElementById('accountArea');
  if(currentUser){ 
    accountArea.innerHTML = `<div style="font-weight:700">${currentUser}</div><div class="data-small">${currentRole}</div>`; 
    document.getElementById('btnLogout').style.display='block'; 
    document.querySelectorAll('.menu-login').forEach(x=>x.style.display='none'); 
  } else { 
    accountArea.innerHTML = '<button id="authHeaderBtn" style="background: white; color: var(--primary); font-weight: 700; padding: 8px 14px; border-radius: 6px; box-shadow: none;">Login</button>'; 
    document.getElementById('authHeaderBtn')?.addEventListener('click', (e)=>{ e.preventDefault(); openAuth('login'); }); 
    document.getElementById('btnLogout').style.display='none'; 
    document.querySelectorAll('.menu-login').forEach(x=>x.style.display='block'); 
  }
  
  // Toggle Admin Dashboard visibility
  const adminLinks = document.querySelectorAll('.admin-only');
  adminLinks.forEach(el=> el.style.display = (currentRole==='admin')? 'block' : 'none');
  
  if (currentRole === 'admin') {
      inputSection.style.display = 'none';
      adminDashboard.style.display = 'block';
      renderAdminStats();
  } else {
      inputSection.style.display = 'block';
      adminDashboard.style.display = 'none';
  }
}

function renderWho(){ 
    let childName = '';
    const childData = getCurrentChildData();
    if (childData) {
        const age = calculateAge(childData.dob);
        childName = `${childData.name} (${age} bulan) - Tgl Lahir: ${childData.dob}`;
    }

    document.getElementById('whoInfo').innerText = currentUser 
        ? `Masuk sebagai ${currentUser} (${currentRole})${currentRole === 'user' ? (childName ? ` | Data Aktif: ${childName}` : ' | Belum ada data anak.') : ''}` 
        : 'Belum login'; 
}


// Input save
async function fileToBase64(file){ return new Promise((res,rej)=>{ const r=new FileReader(); r.onload=()=>res(r.result); r.onerror=rej; r.readAsDataURL(file); }); }

document.getElementById('btnSave').addEventListener('click', async ()=>{
  if(!currentUser || currentRole === 'admin'){ showToast('Silakan login sebagai user biasa untuk menyimpan data', 'error'); return; }
  if(!currentChildId){ showToast('Silakan pilih atau tambahkan data anak terlebih dahulu.', 'error'); return; }

  const tinggi = document.getElementById('tinggi').value; 
  const berat = document.getElementById('berat').value; 
  const catatan = document.getElementById('catatan').value.trim(); 
  const fotoFile = document.getElementById('foto').files[0];
  
  if(!tinggi || !berat){ showToast('Lengkapi data penting (Tinggi & Berat)', 'error'); return; }
  
  const users = getUsers(); 
  const childData = getCurrentChildData();
  const entry = { 
    id: Date.now(), 
    tanggal_input: new Date().toISOString().split('T')[0],
    usia_bulan: calculateAge(childData.dob),
    tinggi: Number(tinggi), 
    berat: Number(berat), 
    catatan: catatan, 
    foto: null 
  };
  
  if(fotoFile) {
      if(fotoFile.size > 2 * 1024 * 1024) { 
          showToast('Ukuran foto terlalu besar (Max 2MB)', 'error');
          return;
      }
      entry.foto = await fileToBase64(fotoFile);
  }
  
  users[currentUser].children[currentChildId].data = users[currentUser].children[currentChildId].data || [];
  users[currentUser].children[currentChildId].data.push(entry); 
  saveUsers(users); 
  showToast('Data perkembangan tersimpan', 'success'); 
  renderList(); 
  renderChart(); 
  
  // clear form
  document.getElementById('tinggi').value=''; 
  document.getElementById('berat').value=''; 
  document.getElementById('catatan').value=''; 
  document.getElementById('foto').value='';
});

// Data list (grid)
function renderList(){ 
  const list = document.getElementById('dataList'); list.innerHTML=''; 
  if(!currentUser || currentRole === 'admin'){ list.innerHTML = '<div class="data-small">Login sebagai user untuk melihat riwayat data.</div>'; return; } 
  if(!currentChildId){ list.innerHTML = '<div class="data-small">Silakan tambahkan data anak di menu "Atur Anak".</div>'; return; }

  const users = getUsers(); 
  const entries = users[currentUser].children[currentChildId]?.data || []; 
  
  if(!entries.length) { list.innerHTML = '<div class="data-small">Belum ada data perkembangan untuk anak ini.</div>'; return; }
  
  entries.slice().reverse().forEach(e=>{ 
    const fotoSrc = e.foto||'data:image/svg+xml;utf8,<svg xmlns=\"http://www.w3.org/2000/svg\" width=\"320\" height=\"180\" viewBox=\"0 0 320 180\"><rect width=\"100%\" height=\"100%\" fill=\"%23eef4ff\"/><text x=\"50%\" y=\"50%\" font-family=\"Inter\" font-size=\"24\" fill=\"%234f46e5\" text-anchor=\"middle\" dominant-baseline=\"middle\">No Photo</text></svg>';
    
    const d = document.createElement('div'); d.className = 'card-grid'; 
    
    // Tentukan status gizi untuk riwayat ini
    const statusResult = getGrowthStatus(e.tinggi, e.berat);
    const statusBadge = `<span class="status-badge ${statusResult.class}" style="margin-top: 0; margin-bottom: 0;">${statusResult.status}</span>`;

    d.innerHTML = `
        <img src="${fotoSrc}" alt="Foto ${getCurrentChildData().name}" onclick="openImagePreview('${fotoSrc}')">
        <div class="info">
            <strong>${getCurrentChildData().name}</strong>
            ${statusBadge}
            <div class="meta">${e.usia_bulan} bulan</div>
            <div class="meta">${e.tinggi} cm ‚Ä¢ ${e.berat} kg</div>
            <div class="meta data-small">Tgl Input: ${e.tanggal_input}</div>
            <div style="margin-top:4px" class="data-small">${e.catatan||'Tidak ada catatan.'}</div>
            <button class="delete-btn" onclick="event.stopPropagation(); deleteEntry(${e.id});">üóëÔ∏è Hapus</button>
        </div>`; 
    list.appendChild(d); 
  }); 
}

// Chart ‚Äî Chart.js
let chart = null;
function renderChart(){
  try{
    const canvas = document.getElementById('growthChart');
    const statusEl = document.getElementById('growthStatus');
    
    const existing = Chart.getChart(canvas);
    if(existing){ existing.destroy(); }
    
    const ctx = canvas.getContext('2d');
    if(!ctx) return;

    if(!currentUser || currentRole === 'admin' || !currentChildId){
      statusEl.innerText = 'Data Tidak Tersedia';
      statusEl.className = 'status-badge'; 
      chart = new Chart(ctx, { /* ... Chart default settings ... */ });
      return;
    }

    const childData = getCurrentChildData();
    const data = (childData.data) ? childData.data.slice() : [];
    
    data.sort((a,b)=>a.usia_bulan - b.usia_bulan); 

    if(!data.length){
      statusEl.innerText = 'Belum ada data untuk anak ini';
      statusEl.className = 'status-badge';
      chart = new Chart(ctx, { /* ... Chart no data settings ... */ });
      return;
    }
    
    // Tampilkan status gizi terbaru
    const latestEntry = data[data.length - 1];
    const statusResult = getGrowthStatus(latestEntry.tinggi, latestEntry.berat);
    statusEl.innerText = `Status Terbaru: ${statusResult.status}`;
    statusEl.className = `status-badge ${statusResult.class}`;


    const labels = data.map(d => String(d.usia_bulan));
    const tinggi = data.map(d => d.tinggi);
    const berat = data.map(d => d.berat);

    chart = new Chart(ctx, {
      type: 'line',
      data: {
        labels,
        datasets: [
          { 
            label: 'Tinggi (cm)', 
            data: tinggi, 
            borderColor: '#4f46e5', 
            backgroundColor: 'rgba(79,70,229,0.1)', 
            tension: 0.4, 
            fill: false,
            pointRadius: 6,
            pointHoverRadius: 8
          },
          { 
            label: 'Berat (kg)', 
            data: berat, 
            borderColor: '#ff8c42', 
            backgroundColor: 'rgba(255,140,66,0.1)', 
            tension: 0.4, 
            fill: false,
            pointRadius: 6,
            pointHoverRadius: 8
          }
          // Idealnya, di sini ditambahkan dataset untuk Kurva WHO Median, -2SD, +2SD
        ]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            tooltip: { mode: 'index', intersect: false, bodyFont: { size: 14 }, titleFont: { size: 15 } },
            legend: { position: 'bottom', labels: { boxWidth: 12, font: { size: 14 } } },
            title: { display: true, text: `Grafik Pertumbuhan ${childData.name}`, font: { size: 16 } }
        },
        scales: {
          x: {
              title: { display: true, text: 'Usia (bulan)', font: { size: 14, weight: 'bold' } }, ticks: { font: { size: 12 } }
          },
          y: { 
              beginAtZero: true,
              title: { display: true, text: 'Tinggi (cm) / Berat (kg)', font: { size: 14, weight: 'bold' } }, ticks: { font: { size: 12 } }
          }
        }
      }
    });
  }catch(err){
    console.error('renderChart error', err);
    showToast('Gagal memuat grafik. Cek konsol.', 'error');
  }
}

// --- EXPORT FUNCTION ---
document.getElementById('btnExportCSV').addEventListener('click', () => {
    if (!currentUser || currentRole === 'admin' || !currentChildId) {
        showToast('Login sebagai user dan pilih anak untuk ekspor data.', 'error');
        return;
    }

    const childData = getCurrentChildData();
    const data = childData.data || [];

    if (data.length === 0) {
        showToast('Tidak ada data yang bisa diekspor.', 'warning');
        return;
    }

    // Filter data untuk CSV (hapus field 'foto' yang berisi Base64 string panjang)
    const dataToExport = data.map(entry => {
        const { foto, id, ...rest } = entry;
        return rest;
    });

    const csv = Papa.unparse(dataToExport);

    const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement('a');
    
    const filename = `FARESTA_Data_${childData.name.replace(/\s/g, '_')}_${new Date().toISOString().split('T')[0]}.csv`;
    
    link.href = URL.createObjectURL(blob);
    link.setAttribute('download', filename);
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    
    showToast('Data berhasil diunduh dalam format CSV', 'success');
});


// --- INIT LISTENERS ---
function initListeners() {
    // Sidebar Navigation:
    sidebarBtn.addEventListener('click', (e)=>{ e.stopPropagation(); if(sidebar.classList.contains('open')) closeSidebar(); else openSidebar(); });
    // Overlay listener ada di atas

    document.getElementById('openAuth').addEventListener('click', (e)=>{ e.preventDefault(); openAuth('login'); closeSidebar(); });
    
    // Auth Modal Switches:
    document.getElementById('showRegister').addEventListener('click', ()=> openAuth('register'));
    document.getElementById('showLogin').addEventListener('click', ()=> openAuth('login'));
    
    // Auth Actions:
    document.getElementById('btnRegister').addEventListener('click', ()=>{
      const u = document.getElementById('regUser').value.trim(); const p = document.getElementById('regPass').value; if(!u||!p){ showToast('Isi username & password', 'error'); return; }
      const users = getUsers(); if(users[u]){ showToast('Username sudah ada', 'error'); return; }
      users[u] = { password: p, children: {} }; // Skema baru: Gunakan 'children'
      saveUsers(users); showToast('Akun dibuat ‚Äî silakan login', 'success'); openAuth('login'); document.getElementById('regUser').value=''; document.getElementById('regPass').value='';
      renderAdminStats(); 
    });
    document.getElementById('btnLogin').addEventListener('click', ()=>{
      const u = document.getElementById('loginUser').value.trim(); const p = document.getElementById('loginPass').value; if(!u||!p){ showToast('Isi username & password', 'error'); return; }
      const users = getUsers(); 
      
      let newChildId = null;

      if(u==='admin' && p==='admin123'){ 
        currentUser='admin'; 
        currentRole='admin'; 
      } else if(users[u] && users[u].password === p) {
        currentUser = u; 
        currentRole = 'user';
        // Ambil ID anak pertama jika ada, untuk default sesi
        newChildId = Object.keys(users[u].children || {})[0] || null;
      } else {
        showToast('Username / password salah', 'error'); return; 
      }
      
      currentChildId = newChildId;
      saveSession(currentUser, currentRole, currentChildId);
      closeModal(authModal); closeSidebar(); renderAllData(); showToast('Login berhasil', 'success');
    });
    
    document.getElementById('btnLogout').addEventListener('click', ()=>{ 
        clearSession(); 
        currentUser=null; 
        currentRole=null;
        currentChildId=null;
        renderAllData(); 
        showToast('Logout berhasil', 'info'); 
    });
    
    // Admin Link Handler:
    document.getElementById('adminLink').addEventListener('click', (e)=>{
        e.preventDefault();
        if (currentRole === 'admin') {
            renderAllData(); 
            showToast('Menampilkan Dashboard Admin', 'info');
        }
    });
}

// initial load and setup
document.addEventListener('DOMContentLoaded', () => {
    loadSession(); // MEMUAT SESI DARI LOCAL STORAGE
    initListeners();
    renderAllData();
});

// Ensure chart re-renders on resize 
window.addEventListener('resize', ()=> {
    setTimeout(renderChart, 100); 
});
</script>
</body>
  </html>
