<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>FARESTA ‚Äî Laporan Tumbuh Kembang</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
<style>
:root{
  --primary: #4f46e5; /* Tailwind indigo-600 */
  --primary-light: #6366f1; /* Tailwind indigo-500 */
  --primary-bg: #eef2ff; /* Tailwind indigo-50 */
  --muted: #6b7280;
  --card: #fff;
  --bg: #f3f4f6; /* Lighter background */
  --shadow-sm: 0 1px 3px rgba(0,0,0,0.08);
  --shadow-md: 0 4px 6px rgba(0,0,0,0.1);
  --success: #10b981; /* Tailwind emerald-500 */
  --error: #ef4444; /* Tailwind red-500 */
  --warning: #f59e0b; /* Tailwind amber-500 */
}
*{box-sizing:border-box; font-family:Inter,system-ui,-apple-system,'Segoe UI',Roboto,Arial;} /* Terapkan font konsisten */
html,body{height:100%;margin:0;color:#1f2937;background:var(--bg)}

/* --- Sidebar --- */
#sidebarBtn{position:fixed;top:16px;left:16px;z-index:140;background:var(--primary);color:#fff;border:0;padding:10px;border-radius:12px;cursor:pointer;box-shadow:var(--shadow-md); transition: transform .3s ease;}
#sidebarBtn:hover{transform: scale(1.05);}
#sidebar{position:fixed;top:16px;left:16px;width:200px;background:var(--primary);border-radius:12px;padding:8px;box-shadow:0 10px 30px rgba(15,23,42,.15);transform:translateX(-250px);transition:transform .3s cubic-bezier(0.68, -0.55, 0.265, 1.55);z-index:130}
#sidebar.open{transform:translateX(0)}
#sidebar .panel{background:#fff;color:#1f2937;border-radius:10px;padding:10px;margin-top:8px;box-shadow:var(--shadow-sm)}
#sidebar h3{margin:0 0 6px;font-size:14px;color:#fff}
#sidebar a{display:flex;align-items:center;gap:8px;padding:10px;border-radius:8px;text-decoration:none;color:#1f2937;margin-bottom:6px;background:var(--primary-bg);font-weight:600;transition:background .15s ease}
#sidebar a:hover{background:#dbeafe}
#sidebar a.admin-only{display:none}
#overlay{position:fixed;inset:0;background:rgba(0,0,0,0.18);z-index:120;display:none;opacity:0;transition:opacity .3s ease}
#overlay.show{display:block;opacity:1}

/* --- Layout --- */
.container{
    max-width:1200px;
    margin:24px auto; 
    padding:16px;
}
.header{
    background:linear-gradient(135deg,var(--primary),var(--primary-light));
    padding:28px;
    border-radius:16px;
    color:#fff; 
    display:flex;
    gap:20px;
    align-items:center;
    box-shadow:var(--shadow-md); 
    margin-bottom: 20px;
} 
.header .title{font-size:24px;font-weight:700}
.header .subtitle{opacity:.9;font-size:15px}
.row{display:grid;grid-template-columns:1fr 360px;gap:20px;margin-top:0} 
.card{
    background:var(--card);
    padding:20px; 
    border-radius:12px;
    box-shadow:var(--shadow-md);
    border: 1px solid #e5e7eb; 
}
.card h4 {
    font-size: 18px; 
    margin-top: 0;
    margin-bottom: 15px; 
    font-weight: 700;
}

/* --- Elements --- */
.field{margin-top:14px} 
label{display:block;margin-bottom:4px;font-weight:600;font-size:15px; color:#1f2937} 
input:not([type="file"]),textarea,select{
    width:100%;
    padding:10px 12px; 
    border-radius:8px; 
    border:1px solid #d1d5db;
    background:#fff;
    font-size:15px; 
    margin-bottom: 5px; 
    transition:border-color .2s ease
}
input:focus,textarea:focus,select:focus{border-color:var(--primary);outline:none}
button{background:var(--primary);color:#fff;padding:12px 18px;border-radius:8px;border:0;cursor:pointer;font-weight:600;transition:background .2s ease;font-size:15px;box-shadow:0 2px 4px rgba(0,0,0,0.1)} 
button:hover{background:var(--primary-light)}
button.ghost{background:transparent;color:var(--primary);border:1px solid var(--primary-bg);box-shadow:none}
button.ghost:hover{background:var(--primary-bg)}
.select-child {
    display: flex;
    gap: 10px;
    align-items: center;
    margin-bottom: 15px;
    padding: 10px;
    border: 1px solid var(--primary-bg);
    border-radius: 8px;
    background: var(--primary-bg);
}

/* --- Data Grid (Riwayat) --- */
.grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(160px,1fr));gap:14px} 
.card-grid{background:#fff;border-radius:10px;padding:10px;box-shadow:var(--shadow-sm);display:flex;flex-direction:column;align-items:stretch;border:1px solid #e5e7eb; cursor: pointer;} 
/* Placeholder Icon */
.card-grid .placeholder-icon {
    width: 100%;
    height: 100px; 
    display: flex;
    justify-content: center;
    align-items: center;
    background-color: var(--primary-bg); 
    border-radius: 8px;
    margin-bottom: 8px;
}
.card-grid .placeholder-icon svg {
    width: 40px;
    height: 40px;
    color: var(--primary);
}

.card-grid .info{padding:4px}
.card-grid strong{font-size:16px; color:#1f2937;} 
.card-grid .meta{color:var(--muted);font-size:14px;line-height:1.4} 
.delete-btn {
    background: var(--error);
    color: white;
    padding: 8px 12px; 
    border-radius: 6px;
    font-size: 14px; 
    margin-top: 8px;
    width: 100%;
    transition: background .2s ease;
}
.delete-btn:hover { background: #cc3333; }
.btn-group {
    display: flex;
    gap: 8px;
    margin-top: 15px;
}

/* Status Gizi */
.status-badge {
    display: inline-block;
    padding: 4px 8px;
    border-radius: 4px;
    font-weight: 700;
    font-size: 12px;
    margin-top: 5px;
    margin-bottom: 10px;
    color: white;
}
.status-badge.normal { background: var(--success); }
.status-badge.underweight, .status-badge.overweight { background: var(--warning); }
.status-badge.severe { background: var(--error); }


/* Admin Dashboard styles */
.admin-stats {
    display: flex;
    gap: 16px; 
    margin-bottom: 20px;
}
.stat-box {
    flex: 1;
    padding: 16px; 
    border-radius: 10px;
    background: var(--primary-bg);
    border: 1px solid #e0e7ff;
    text-align: center;
}
.stat-box .count {
    font-size: 30px; 
    font-weight: 700;
    color: var(--primary);
}
.stat-box .label {
    font-size: 14px; 
    color: var(--muted);
    margin-top: 4px;
}
/* Admin User List */
#userListAdmin {
    max-height: 300px;
    overflow-y: auto;
    border: 1px solid #e5e7eb;
    border-radius: 8px;
    padding: 5px 0;
}
.user-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 10px 15px;
    border-bottom: 1px solid #f3f4f6;
    font-size: 15px;
}
.user-item:last-child {
    border-bottom: none;
}
.user-item strong {
    font-weight: 600;
}
.user-item span {
    color: var(--muted);
    font-size: 13px;
}
/* Search Admin */
#adminSearch {
    width: 100%;
    margin-bottom: 10px;
}


/* --- Modal --- */
.modal{position:fixed;left:50%;top:50%;transform:translate(-50%,-50%) scale(0.9);z-index:200;background:#fff;padding:24px;border-radius:16px;box-shadow:0 20px 50px rgba(15,23,42,.25);width:360px;max-width:94vw;display:none;opacity:0;transition:opacity .3s ease, transform .3s cubic-bezier(0.175, 0.885, 0.32, 1.27)}
.modal.open{display:block;opacity:1;transform:translate(-50%,-50%) scale(1)} /* Smooth fade-in and pop */
.modal h4{margin:0 0 10px;font-size:18px}
.modal #loginBlock, .modal #registerBlock { display: flex; flex-direction: column; gap: 8px;} 
.modal-overlay {
    position: fixed;
    inset: 0;
    background: rgba(0, 0, 0, 0.5);
    z-index: 190;
    display: none;
}
.modal.open ~ .modal-overlay {
    display: block;
}

/* Modal Detail Riwayat */
#detailModal {
    width: 450px; 
    max-width: 90vw;
}
#detailModal .detail-field {
    display: flex;
    justify-content: space-between;
    padding: 8px 0;
    border-bottom: 1px dashed #eee;
    font-size: 15px;
}
#detailModal .detail-field strong { font-weight: 600; }
#detailModal .detail-field span { color: var(--muted); }
#detailModal p { white-space: pre-wrap; margin: 10px 0; background: var(--primary-bg); padding: 10px; border-radius: 8px; font-style: italic; }

/* Imunisasi table */
#immunizationTable table { width: 100%; border-collapse: collapse; font-size: 13px; }
#immunizationTable th, #immunizationTable td { padding: 8px 5px; text-align: left; border-bottom: 1px solid #eee; }
#immunizationTable th { background: #f3f4f6; font-weight: 700; color: #1f2937; }
.imun-status { padding: 3px 6px; border-radius: 4px; font-weight: 600; font-size: 12px; }
.imun-status.done { background: var(--success); color: white; }
.imun-status.pending { background: var(--warning); color: #333; }
.imun-status.missed { background: var(--error); color: white; }


/* --- Chart --- */
.chart-box{height:350px;margin-top:10px} 

/* --- Snackbar Notification (New) --- */
#snackbarContainer{
    position:fixed;
    bottom:20px;
    left:50%;
    transform:translateX(-50%);
    z-index:1000;
    width: 90%;
    max-width: 400px;
    pointer-events: none;
} 
.snackbar{
    background:var(--card);
    color:#333;
    padding:14px 20px;
    border-radius:8px;
    box-shadow:0 6px 16px rgba(0,0,0,0.25);
    margin-bottom:10px;
    display:flex;
    align-items:center;
    gap:12px;
    opacity:0;
    transform:translateY(20px);
    transition:opacity .3s ease, transform .3s ease;
    pointer-events: auto;
    border-left: 5px solid; 
}
.snackbar.show{opacity:1;transform:translateY(0)}
.snackbar.success { border-left-color: var(--success); }
.snackbar.error { border-left-color: var(--error); }
.snackbar.warning { border-left-color: var(--warning); }
.snackbar.info { border-left-color: var(--primary); }

.snackbar .icon{font-size:20px;line-height:1;margin-top:-2px}
.snackbar .message{font-weight:500;font-size:15px} 

/* Loading State (New) */
.loading-spinner {
    border: 3px solid rgba(255, 255, 255, 0.3);
    border-top: 3px solid #fff;
    border-radius: 50%;
    width: 20px;
    height: 20px;
    animation: spin 1s linear infinite;
    display: inline-block;
    margin-right: 8px;
}
@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

/* --- Responsive --- */
@media(max-width:980px){
  .row{grid-template-columns:1fr; gap: 16px;}
  .header{flex-direction:column;align-items:flex-start}
  .container{padding: 16px;} 
  .card{padding:18px;} 
  #sidebar{width:180px}
  #snackbarContainer{left: 10px; right: 10px; transform: none; width: auto; max-width: none;}
  .admin-stats { flex-direction: column; }
}
</style>
</head>
<body>

<button id="sidebarBtn" title="Menu">
    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
        <path d="M4 6H20M4 12H20M4 18H20" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
    </svg>
</button>
<div id="sidebar" aria-hidden="true">
  <div style="display:flex;align-items:center;gap:10px;padding:8px 10px;color:#fff;font-size:18px">
    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M12 2C6.477 2 2 6.477 2 12C2 17.523 6.477 22 12 22C17.523 22 22 17.523 22 12C22 6.477 17.523 2 12 2Z" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><path d="M12 16C14.2091 16 16 14.2091 16 12C16 9.79086 14.2091 8 12 8C9.79086 8 8 9.79086 8 12C8 14.2091 9.79086 16 12 16Z" fill="white" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
    <div style="font-weight:700">FARESTA</div>
  </div>
  <div class="panel" id="sidebarPanel" style="display:none">
    <a href="#home" data-nav>üè° Beranda</a>
    <a href="#imunisasi" id="imunisasiLink" data-nav style="display: none;">üíâ Imunisasi</a>
    <a href="#" id="openAuth" class="menu-login">üîë Login / Register</a>
    <a href="#dashboard" data-nav id="adminLink" class="admin-only">‚öôÔ∏è Dashboard Admin</a>
    <a href="#about" data-nav>üí° Tentang</a>
    <a href="#" id="btnLogout" style="display:none">üö™ Logout</a>
  </div>
</div>
<div id="overlay"></div>

<div id="snackbarContainer"></div>

<div class="container">
  <div class="header">
    <svg width="40" height="40" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12C2 6.47715 6.47715 2 12 2Z" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><path d="M12 16C14.2091 16 16 14.2091 16 12C16 9.79086 14.2091 8 12 8C9.79086 8 8 9.79086 8 12C8 14.2091 9.79086 16 12 16Z" fill="white" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
    <div>
      <div class="title">FARESTA ‚Äî Laporan Tumbuh Kembang</div>
      <div class="subtitle">Pantau perkembangan anak dengan mudah dan cepat.</div>
    </div>
    <div style="margin-left:auto; text-align:right" id="accountArea"></div>
  </div>

  <div class="row">
    <main id="mainContent">
      <div class="card admin-only content-section" id="adminDashboard" style="display:none; margin-bottom: 20px;">
        <h4>üìä Dashboard Admin</h4>
        <div class="admin-stats">
            <div class="stat-box">
                <div class="count" id="statUsers">0</div>
                <div class="label">Total User Terdaftar</div>
            </div>
            <div class="stat-box">
                <div class="count" id="statVisits">0</div>
                <div class="label">Total Kunjungan Website</div>
            </div>
        </div>
        
        <h5 style="font-size: 16px; font-weight: 700; margin-top: 15px; margin-bottom: 10px;">Daftar Username User Biasa:</h5>
        <input id="adminSearch" placeholder="Cari Username..." onkeyup="renderAdminStats()" />
        <div id="userListAdmin">
            </div>
      </div>
      
      <div class="card content-section" id="inputSection">
        <h4>Input Data Perkembangan Anak</h4>
        <div class="data-small" id="whoInfo">Belum login</div>

        <div id="childSelectorArea" class="select-child" style="display:none;">
            <label for="childSelect" style="margin:0; font-weight: 700;">Pilih Anak:</label>
            <select id="childSelect" style="flex-grow:1; margin-bottom: 0;"></select>
            <button id="btnManageChildren" class="ghost" style="padding: 8px 12px; font-size: 14px;">üë∂ Atur Anak</button>
        </div>

        <div class="field"><label for="tinggi">Tinggi (cm)</label><input id="tinggi" placeholder="Cth: 80.5" type="number" min="0" step="0.1" /></div>
        <div class="field"><label for="berat">Berat (kg)</label><input id="berat" placeholder="Cth: 10.2" type="number" min="0" step="0.1" /></div>
        <div class="field"><label for="catatan">Catatan Perkembangan</label><textarea id="catatan" placeholder="Cth: Sudah bisa berjalan tanpa pegangan..."></textarea></div>
        <div class="field">
            <button id="btnSave" style="width: 100%;">üíæ Simpan Data</button>
        </div>
      </div>
      
      <div class="card content-section" id="imunisasiSection" style="margin-top:20px; display:none;">
        <h4>üíâ Jadwal Imunisasi</h4>
        <div id="imunisasiInfo" class="data-small">Silakan pilih data anak terlebih dahulu.</div>
        <div id="imunisasiTable">
            </div>
      </div>


      <div class="card content-section" id="chartCard" style="margin-top:20px">
        <h4>üìà Grafik Pertumbuhan Anak (vs. Standar WHO)</h4>
        <div id="growthStatus" class="status-badge">Data Tidak Lengkap</div>
        <div class="chart-box"><canvas id="growthChart" aria-label="Grafik pertumbuhan" role="img"></canvas></div>
        <div class="btn-group">
            <button id="btnExportCSV">üì• Ekspor Data (CSV)</button>
            <button id="btnExportPDF" class="ghost" disabled title="Fitur Proyeksi">üñ®Ô∏è Ekspor PDF (Coming Soon)</button>
        </div>
      </div>

      <div class="card content-section" id="aboutSection" style="margin-top:20px"> <h4>üí° Tentang FARESTA</h4>
        <p style="line-height:1.6; font-size: 15px;">FARESTA membantu orang tua menyimpan catatan tumbuh kembang anak dan melihat grafik perkembangan. Data disimpan secara lokal di browser Anda (LocalStorage) sehingga aman dan cepat.</p>
      </div>
    </main>

    <aside id="asideContent">
      <div class="card" id="authCard">
        <h4>Data Tersimpan (Riwayat)</h4>
        <div id="dataList" class="grid"></div>
      </div>
    </aside>
  </div>
</div>

<div id="authModal" class="modal" aria-hidden="true">
  <h4 id="authTitle">Login</h4>
  <div id="loginBlock">
    <input id="loginUser" placeholder="Username">
    <input id="loginPass" placeholder="Password" type="password">
    <div style="display:flex;gap:8px;margin-top:8px"><button id="btnLogin" style="flex-grow:1">Login</button><button id="showRegister" class="ghost">Register</button></div>
    <div style="text-align:center; margin-top:10px;"><a href="#" id="showForgotPassword" style="font-size:14px; color: var(--primary); text-decoration: none;">Lupa Password?</a></div>
  </div>
  <div id="registerBlock" style="display:none">
    <input id="regUser" placeholder="Username">
    <input id="regPass" placeholder="Password" type="password">
    <div style="display:flex;gap:8px;margin-top:8px"><button id="btnRegister" style="flex-grow:1">Buat Akun</button><button id="showLogin" class="ghost">Kembali</button></div>
  </div>
</div>

<div id="forgotPasswordModal" class="modal" aria-hidden="true">
    <h4>Reset Password</h4>
    <div class="data-small" style="color: var(--error); margin-bottom: 10px; padding: 10px; border: 1px solid var(--error); border-radius: 8px;">
        ‚ö†Ô∏è **Peringatan:** Ini adalah aplikasi *client-side*. Tidak ada verifikasi email. Password akan langsung direset jika Username ditemukan.
    </div>
    <input id="forgotUser" placeholder="Username Anda">
    <input id="forgotNewPass" placeholder="Password Baru" type="password">
    <div style="display:flex;gap:8px;margin-top:10px">
        <button id="btnResetPass" style="flex-grow:1">Ganti Password</button>
        <button id="cancelReset" class="ghost">Batal</button>
    </div>
</div>

<div id="manageChildModal" class="modal" aria-hidden="true">
    <h4>üë∂ Atur Anak</h4>
    <div id="childListManagement" style="max-height: 200px; overflow-y: auto; margin-bottom: 15px;">
        </div>
    <hr style="border: 0; border-top: 1px solid #e5e7eb;">
    <h5 style="margin-top: 15px; font-size: 16px; font-weight: 600;">Tambah Anak Baru</h5>
    <input id="newChildName" placeholder="Nama Anak">
    <div class="field"><label for="newChildDOB">Tanggal Lahir Anak</label><input id="newChildDOB" type="date"></div>
    <div class="field">
        <label for="newChildGender">Jenis Kelamin</label>
        <select id="newChildGender">
            <option value="male">Laki-laki</option>
            <option value="female">Perempuan</option>
        </select>
    </div>
    <button id="btnAddChild">‚ûï Tambah Anak</button>
</div>

<div id="detailModal" class="modal" aria-hidden="true">
    <h4>Detail Riwayat <span id="detailChildName" style="color:var(--primary); font-size: 16px;"></span></h4>
    <div class="detail-field"><strong>Tanggal Input</strong><span id="detailTanggal"></span></div>
    <div class="detail-field"><strong>Usia</strong><span id="detailUsia"></span></div>
    <div class="detail-field"><strong>Jenis Kelamin</strong><span id="detailGender"></span></div>
    <div class="detail-field"><strong>Tinggi Badan</strong><span id="detailTinggi"></span></div>
    <div class="detail-field"><strong>Berat Badan</strong><span id="detailBerat"></span></div>
    <div class="detail-field"><strong>Status Gizi</strong><span id="detailStatus"></span></div>
    <h5 style="font-size: 16px; margin: 15px 0 5px;">Catatan Perkembangan:</h5>
    <p id="detailCatatan"></p>
    <button id="detailDeleteBtn" class="delete-btn" style="width: 100%; margin-top: 10px;">üóëÔ∏è Hapus Riwayat Ini</button>
</div>

<div class="modal-overlay"></div>


<script>
// --- GLOBAL CONSTANTS & HELPERS ---
const USERS_KEY = 'faresta_users_v4'; 
const VISIT_COUNT_KEY = 'faresta_visit_count_v1';
const SESSION_USER_KEY = 'faresta_session_user';
const SESSION_ROLE_KEY = 'faresta_session_role';
const SESSION_CHILD_KEY = 'faresta_session_child_id'; 

const getUsers = ()=> JSON.parse(localStorage.getItem(USERS_KEY) || '{}');
const saveUsers = u=> localStorage.setItem(USERS_KEY, JSON.stringify(u));

let currentUser = null; 
let currentRole = null; 
let currentChildId = null; 

// --- WHO GROWTH CHART DATA SIMULATED (Separated by Gender) ---
const WHO_SIMULATED_DATA = {
    // Berat-per-Tinggi (WFL) for quick status check (Simplified)
    wfl_simulation: {
        male: { '60': 5.6, '70': 7.7, '80': 9.9, '90': 12.3, '100': 15.0, '110': 17.5 },
        female: { '60': 5.4, '70': 7.4, '80': 9.5, '90': 11.9, '100': 14.5, '110': 17.0 }
    },
    // Berat Badan (kg) per Usia (Bulan) - Contoh 0 hingga 24 bulan
    weight: {
        male: {
            labels: [0, 3, 6, 9, 12, 18, 24],
            median: [3.3, 6.4, 7.8, 9.2, 10.2, 11.5, 12.5],
            sd_plus2: [4.5, 8.5, 9.8, 11.5, 12.7, 14.2, 15.5],
            sd_minus2: [2.1, 4.3, 5.8, 6.9, 7.7, 8.8, 9.5]
        },
        female: {
            labels: [0, 3, 6, 9, 12, 18, 24],
            median: [3.2, 5.8, 7.2, 8.6, 9.5, 10.8, 11.8],
            sd_plus2: [4.4, 7.7, 9.2, 10.8, 11.9, 13.5, 14.7],
            sd_minus2: [2.0, 4.0, 5.4, 6.5, 7.2, 8.3, 9.0]
        }
    }
};

// --- IMUNISASI SCHEDULE (Simplified) ---
const IMUNISASI_SCHEDULE = [
    { name: "Hepatitis B-0", age: 0, notes: "Diberikan segera setelah lahir (Maks. 24 jam)" },
    { name: "BCG, Polio 1", age: 1, notes: "Usia 1 bulan" },
    { name: "DPT-HB-HiB 1, Polio 2, Rotavirus 1", age: 2, notes: "Usia 2 bulan" },
    { name: "DPT-HB-HiB 2, Polio 3", age: 3, notes: "Usia 3 bulan" },
    { name: "DPT-HB-HiB 3, Polio 4, Rotavirus 2", age: 4, notes: "Usia 4 bulan" },
    { name: "Campak", age: 9, notes: "Usia 9 bulan" },
    { name: "DPT-HB-HiB (Lanjutan)", age: 18, notes: "Usia 18 bulan (Booster)" }
];


// --- SESSION MANAGEMENT FUNCTIONS ---
function saveSession(username, role, childId = null) {
    localStorage.setItem(SESSION_USER_KEY, username);
    localStorage.setItem(SESSION_ROLE_KEY, role);
    if (childId) {
        localStorage.setItem(SESSION_CHILD_KEY, childId);
    } else {
        localStorage.removeItem(SESSION_CHILD_KEY);
    }
}

function clearSession() {
    localStorage.removeItem(SESSION_USER_KEY);
    localStorage.removeItem(SESSION_ROLE_KEY);
    localStorage.removeItem(SESSION_CHILD_KEY);
}

function loadSession() {
    const user = localStorage.getItem(SESSION_USER_KEY);
    const role = localStorage.getItem(SESSION_ROLE_KEY);
    const childId = localStorage.getItem(SESSION_CHILD_KEY);

    if (user && role) {
        currentUser = user;
        currentRole = role;
        currentChildId = childId;
    }
}

// --- CHILD MANAGEMENT ---

function getCurrentChildData() {
    if (!currentUser || !currentChildId || currentRole === 'admin') return null;
    const users = getUsers();
    return users[currentUser]?.children?.[currentChildId] || null;
}

function renderChildSelector() {
    const childSelect = document.getElementById('childSelect');
    const childSelectorArea = document.getElementById('childSelectorArea');
    childSelect.innerHTML = '';
    
    if (!currentUser || currentRole === 'admin') {
        childSelectorArea.style.display = 'none';
        return;
    }

    const users = getUsers();
    const children = users[currentUser]?.children || {};
    const childKeys = Object.keys(children);

    if (childKeys.length === 0) {
        childSelectorArea.style.display = 'flex';
        childSelect.innerHTML = '<option value="">Silakan atur data anak</option>';
        currentChildId = null;
        saveSession(currentUser, currentRole, null);
    } else {
        childSelectorArea.style.display = 'flex';
        
        // Pilih anak pertama jika tidak ada sesi anak yang valid
        if (!currentChildId || !children[currentChildId]) {
            currentChildId = childKeys[0];
            saveSession(currentUser, currentRole, currentChildId);
        }

        childKeys.forEach(id => {
            const option = document.createElement('option');
            const ageDetail = calculateAge(children[id].dob);
            option.value = id;
            option.innerText = `${children[id].name} (${formatAge(ageDetail)})`;
            if (id === currentChildId) {
                option.selected = true;
            }
            childSelect.appendChild(option);
        });

        // Event listener for changing child
        childSelect.onchange = (e) => {
            currentChildId = e.target.value;
            saveSession(currentUser, currentRole, currentChildId);
            showSnackbar(`Anak diubah ke: ${children[currentChildId].name}`, 'info');
            renderAllData(); // Reload all data based on new child
        };
    }
}

// --- MODAL MANAGEMENT ---
const manageChildModal = document.getElementById('manageChildModal');
const authModal = document.getElementById('authModal');
const detailModal = document.getElementById('detailModal'); 
const forgotPasswordModal = document.getElementById('forgotPasswordModal');
const modalOverlay = document.querySelector('.modal-overlay');

document.getElementById('btnManageChildren').addEventListener('click', () => {
    if (!currentUser || currentRole === 'admin') return;
    renderChildManagementList();
    openModal(manageChildModal);
});

document.getElementById('btnAddChild').addEventListener('click', () => {
    const name = document.getElementById('newChildName').value.trim();
    const dob = document.getElementById('newChildDOB').value;
    const gender = document.getElementById('newChildGender').value;

    if (!name || !dob) {
        showSnackbar('Nama, Tanggal Lahir, dan Jenis Kelamin harus diisi.', 'error');
        return;
    }

    const users = getUsers();
    const newChildId = Date.now().toString();

    // Pastikan children, data, dan imunisasi diinisialisasi dengan benar
    users[currentUser].children = users[currentUser].children || {};
    users[currentUser].children[newChildId] = {
        name: name,
        dob: dob,
        gender: gender, // Simpan Jenis Kelamin
        data: [], 
        immunization: {} 
    };
    saveUsers(users);
    showSnackbar(`${name} (${gender==='male'?'Laki-laki':'Perempuan'}) berhasil ditambahkan!`, 'success');

    // Set new child as active
    currentChildId = newChildId;
    saveSession(currentUser, currentRole, currentChildId);

    // Clear form and re-render
    document.getElementById('newChildName').value = '';
    document.getElementById('newChildDOB').value = '';
    document.getElementById('newChildGender').value = 'male';
    closeModal(manageChildModal);
    renderAllData();
    renderChildManagementList();
});

function renderChildManagementList() {
    const list = document.getElementById('childListManagement');
    list.innerHTML = '';
    const users = getUsers();
    const children = users[currentUser]?.children || {};

    Object.keys(children).forEach(id => {
        const child = children[id];
        const ageDetail = calculateAge(child.dob);
        const genderText = child.gender === 'male' ? 'Laki-laki' : 'Perempuan';
        
        const div = document.createElement('div');
        div.style.cssText = 'display:flex; flex-direction: column; gap: 4px; padding: 8px 0; border-bottom: 1px solid #eee;';
        div.innerHTML = `
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <span><strong>${child.name}</strong> (${formatAge(ageDetail)})</span>
                <button onclick="deleteChild('${id}')" style="background: var(--error); padding: 5px 10px; font-size: 13px;">Hapus</button>
            </div>
            <div class="data-small" style="color:var(--muted);">${genderText} | Tgl Lahir: ${child.dob}</div>
        `;
        list.appendChild(div);
    });
    if (Object.keys(children).length === 0) {
        list.innerHTML = '<div class="data-small">Belum ada data anak.</div>';
    }
}

function deleteChild(id) {
    if (!confirm('Yakin ingin menghapus data anak ini? Semua riwayat akan hilang!')) return;

    const users = getUsers();
    delete users[currentUser].children[id];
    saveUsers(users);
    showSnackbar('Data anak berhasil dihapus.', 'success');

    // Update active child if the deleted one was active
    if (currentChildId === id) {
        const remainingChildren = Object.keys(users[currentUser].children || {});
        currentChildId = remainingChildren.length > 0 ? remainingChildren[0] : null;
        saveSession(currentUser, currentRole, currentChildId);
    }
    renderAllData();
    renderChildManagementList();
}


// --- WHO ANALYSIS (SIMPLIFIED BUT GENDER-SPECIFIC) ---

function getGrowthStatus(height, weight, gender = 'male') { 
    if (!height || !weight || height < 60 || height > 110) {
        return { status: 'Data Tidak Lengkap', class: '' };
    }

    const wflData = WHO_SIMULATED_DATA.wfl_simulation[gender] || WHO_SIMULATED_DATA.wfl_simulation.male;

    const nearestHeight = Object.keys(wflData)
        .map(Number)
        .reduce((prev, curr) => (Math.abs(curr - height) < Math.abs(prev - height) ? curr : prev));
        
    const medianWeight = wflData[nearestHeight];

    let status = '';
    let statusClass = '';

    // Perhitungan Z-score sederhana (hanya berdasarkan deviasi dari median)
    const difference = weight - medianWeight;
    // Angka deviasi ini disederhanakan dan harus dikalibrasi ulang jika menggunakan data WHO real.
    // Untuk simulasi, anggap deviasi 1 unit = 1 SD
    
    if (difference < -2) {
        status = 'Gizi Buruk/Sangat Kurang';
        statusClass = 'severe';
    } else if (difference < -1) {
        status = 'Gizi Kurang';
        statusClass = 'underweight';
    } else if (difference > 2.5) {
        status = 'Obesitas';
        statusClass = 'severe';
    } else if (difference > 1.5) {
        status = 'Gizi Lebih';
        statusClass = 'overweight';
    } else {
        status = 'Gizi Baik (Normal)';
        statusClass = 'normal';
    }

    return { status, class: statusClass, median: medianWeight, heightUsed: nearestHeight };
}


// --- VISIT COUNTER ---
function countVisit() {
    let count = parseInt(localStorage.getItem(VISIT_COUNT_KEY) || '0');
    count += 1;
    localStorage.setItem(VISIT_COUNT_KEY, count);
}

// --- INITIAL SETUP: Ensure Admin Exists ---
(function(){ 
    const u=getUsers(); 
    if(!u.admin){ 
        // Admin skema baru: menggunakan properti 'children' kosong
        u.admin={password:'admin123', children: {}}; 
        saveUsers(u); 
    }
    countVisit(); 
})();


// --- SNACKBAR NOTIFICATION FUNCTION (REPLACING TOAST) ---
function showSnackbar(message, type = 'info') {
    const container = document.getElementById('snackbarContainer');
    const snackbar = document.createElement('div');
    snackbar.className = `snackbar ${type}`;
    let icon = '';
    if (type === 'success') icon = '‚úÖ';
    else if (type === 'error') icon = '‚ùå';
    else if (type === 'warning') icon = '‚ö†Ô∏è';
    else icon = 'üí°';
    
    snackbar.innerHTML = `<span class="icon">${icon}</span><span class="message">${message}</span>`;
    container.appendChild(snackbar);
    
    setTimeout(() => {
        snackbar.classList.add('show');
    }, 50);

    setTimeout(() => {
        snackbar.classList.remove('show');
        setTimeout(() => snackbar.remove(), 300); 
    }, 4000);
}

// --- MODAL & PREVIEW FUNCTIONS ---
function openModal(modalEl) {
    // Tutup semua modal sebelum membuka yang baru
    [authModal, manageChildModal, detailModal, forgotPasswordModal].forEach(m => {
        if (m && m !== modalEl) closeModal(m);
    });

    modalEl.classList.add('open');
    modalEl.setAttribute('aria-hidden', 'false');
    modalOverlay.style.display = 'block';
}

function closeModal(modalEl) {
    modalEl.classList.remove('open');
    modalEl.setAttribute('aria-hidden', 'true');
    // Hanya sembunyikan overlay jika tidak ada modal lain yang terbuka
    if (!authModal.classList.contains('open') && !manageChildModal.classList.contains('open') && !detailModal.classList.contains('open') && !forgotPasswordModal.classList.contains('open')) {
        modalOverlay.style.display = 'none';
    }
}

document.getElementById('overlay').addEventListener('click', ()=>{ 
    closeSidebar(); 
    closeModal(authModal); 
    closeModal(manageChildModal); 
    closeModal(detailModal); 
    closeModal(forgotPasswordModal); 
});

document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') {
        if(authModal.classList.contains('open')) closeModal(authModal);
        if(manageChildModal.classList.contains('open')) closeModal(manageChildModal);
        if(detailModal.classList.contains('open')) closeModal(detailModal);
        if(forgotPasswordModal.classList.contains('open')) closeModal(forgotPasswordModal);
        if(sidebar.classList.contains('open')) closeSidebar();
    }
});


// --- AGE CALCULATION FUNCTION ---
function calculateAge(birthDate) {
    if (!birthDate) return null;
    const today = new Date();
    const dob = new Date(birthDate);

    let years = today.getFullYear() - dob.getFullYear();
    let months = today.getMonth() - dob.getMonth();
    let days = today.getDate() - dob.getDate();

    if (days < 0) {
        months--;
        days += new Date(today.getFullYear(), today.getMonth(), 0).getDate(); // Days in previous month
    }
    if (months < 0) {
        years--;
        months += 12;
    }

    // Hitung total bulan (ini yang digunakan untuk plotting WHO)
    const totalMonths = years * 12 + months + (days > 15 ? 0.5 : 0); // Pembulatan sederhana ke tengah bulan
    
    return { 
        years: years, 
        months: months, 
        days: days, 
        totalMonths: Math.round(totalMonths) // Total bulan untuk chart (integer)
    };
}

function formatAge(ageDetail) {
    if (!ageDetail || ageDetail.years === undefined) return 'N/A';
    let output = [];
    if (ageDetail.years > 0) {
        output.push(`${ageDetail.years} thn`);
    }
    if (ageDetail.months > 0 || (ageDetail.years === 0 && ageDetail.days > 0)) {
         output.push(`${ageDetail.months} bln`);
    }
    if (ageDetail.years === 0 && ageDetail.months === 0 && ageDetail.days > 0) {
        output.push(`${ageDetail.days} hari`);
    }
    
    // Jika usia < 1 bulan, tampilkan hari
    if (ageDetail.years === 0 && ageDetail.months === 0) {
         return `${ageDetail.days} hari`;
    }
    
    return output.join(' ');
}

// --- DATA ACTIONS ---
function deleteEntry(id) {
    if (!currentUser || currentRole === 'admin' || !currentChildId) {
        showSnackbar('Aksi ditolak. Silakan login sebagai pengguna dan pilih anak.', 'error');
        return;
    }
    
    const confirmation = confirm('Anda yakin ingin menghapus data ini? Aksi ini tidak dapat dibatalkan.');
    if (!confirmation) {
        return;
    }

    const users = getUsers();
    let data = users[currentUser].children[currentChildId].data || [];
    
    const initialLength = data.length;
    data = data.filter(entry => entry.id !== id);
    
    if (data.length === initialLength) {
        showSnackbar('Data gagal ditemukan.', 'error');
        return;
    }

    users[currentUser].children[currentChildId].data = data;
    saveUsers(users);
    
    closeModal(detailModal); // Tutup modal detail setelah hapus
    showSnackbar('Data berhasil dihapus', 'success');
    renderList();
    renderChart();
    renderImunisasiTable();
}


// --- IMUNISASI FUNCTIONS ---

function renderImunisasiTable() {
    const tableContainer = document.getElementById('imunisasiTable');
    const infoEl = document.getElementById('imunisasiInfo');
    
    if (!currentUser || currentRole === 'admin' || !currentChildId) {
        tableContainer.innerHTML = '';
        infoEl.innerText = 'Silakan login sebagai user dan pilih anak untuk melihat data imunisasi.';
        return;
    }

    const childData = getCurrentChildData();
    const ageDetail = calculateAge(childData.dob);
    const childAgeMonths = ageDetail.totalMonths;
    
    // Pastikan skema data imunisasi ada
    childData.immunization = childData.immunization || {}; 

    infoEl.innerText = `Jadwal Imunisasi untuk ${childData.name} (Usia ${formatAge(ageDetail)}):`;

    let html = `
        <table>
            <thead>
                <tr>
                    <th>Imunisasi</th>
                    <th>Usia Wajib</th>
                    <th>Status</th>
                    <th>Tanggal Diberikan</th>
                    <th>Aksi</th>
                </tr>
            </thead>
            <tbody>
    `;

    IMUNISASI_SCHEDULE.forEach((imun, index) => {
        const key = imun.name.replace(/\s/g, '_');
        const statusData = childData.immunization[key] || {};
        
        let statusClass = 'pending';
        let statusText = 'Pending';
        let givenDate = 'N/A';
        let actionBtn = `<button style="padding: 5px 10px; font-size: 13px;" onclick="markImunizationDone('${key}', ${imun.age})">Tandai Selesai</button>`;

        if (statusData.done) {
            statusClass = 'done';
            statusText = 'Selesai';
            givenDate = statusData.date || '‚Äî';
            actionBtn = `<button style="background: var(--warning); padding: 5px 10px; font-size: 13px;" onclick="markImunizationPending('${key}')">Batal Selesai</button>`;
        } else if (childAgeMonths > imun.age + 2) { // 2 bulan toleransi
            statusClass = 'missed';
            statusText = 'Terlambat/Terlewat';
        }
        
        html += `
            <tr>
                <td><strong>${imun.name}</strong><div class="data-small">${imun.notes}</div></td>
                <td>${imun.age} bulan</td>
                <td><span class="imun-status ${statusClass}">${statusText}</span></td>
                <td>${givenDate}</td>
                <td>${actionBtn}</td>
            </tr>
        `;
    });

    html += `</tbody></table>`;
    tableContainer.innerHTML = html;
}

function markImunizationDone(key, age) {
    const users = getUsers();
    const childData = users[currentUser].children[currentChildId];
    
    const today = new Date().toISOString().split('T')[0];
    const ageDetail = calculateAge(childData.dob);

    childData.immunization[key] = { done: true, date: today, age_given: formatAge(ageDetail) };
    saveUsers(users);
    showSnackbar(`Imunisasi ${key.replace(/_/g, ' ')} berhasil ditandai selesai!`, 'success');
    renderImunisasiTable();
}

function markImunizationPending(key) {
    const users = getUsers();
    const childData = users[currentUser].children[currentChildId];
    
    delete childData.immunization[key]; 
    saveUsers(users);
    showSnackbar(`Status imunisasi ${key.replace(/_/g, ' ')} diubah menjadi Pending.`, 'warning');
    renderImunisasiTable();
}


// --- UI ELEMENTS ---
const sidebarBtn = document.getElementById('sidebarBtn');
const sidebar = document.getElementById('sidebar');
const sidebarPanel = document.getElementById('sidebarPanel');
const overlay = document.getElementById('overlay');
const authTitle = document.getElementById('authTitle');
const adminDashboard = document.getElementById('adminDashboard');
const imunisasiLink = document.getElementById('imunisasiLink');


// Sidebar open/close
function openSidebar(){ sidebar.classList.add('open'); sidebarPanel.style.display='block'; overlay.classList.add('show'); }
function closeSidebar(){ sidebar.classList.remove('open'); sidebarPanel.style.display='none'; overlay.classList.remove('show'); }

// open auth modal
function openAuth(mode='login'){ 
    authTitle.innerText = mode==='login' ? 'Login' : 'Register'; 
    openModal(authModal);
    document.getElementById('loginBlock').style.display=mode==='login' ? 'flex' : 'none'; 
    document.getElementById('registerBlock').style.display=mode==='register' ? 'flex' : 'none'; 
}


// --- ADMIN STATS & LIST USERS ---
function getAdminStats() {
    const users = getUsers();
    const userKeys = Object.keys(users);
    const userCount = userKeys.length; 
    const visitCount = parseInt(localStorage.getItem(VISIT_COUNT_KEY) || '0');
    
    const userList = userKeys.filter(u => u !== 'admin').map(username => {
        const numChildren = Object.keys(users[username].children || {}).length;
        return { username, numChildren, role: 'user' };
    });

    return { userCount: userCount, visitCount: visitCount, userList: userList };
}

function renderAdminStats() {
    const stats = getAdminStats();
    const searchInput = document.getElementById('adminSearch').value.toLowerCase();
    
    document.getElementById('statUsers').innerText = stats.userCount;
    document.getElementById('statVisits').innerText = stats.visitCount;

    // Filter User List
    const filteredUsers = stats.userList.filter(user => 
        user.username.toLowerCase().includes(searchInput)
    );

    // Render User List
    const listContainer = document.getElementById('userListAdmin');
    listContainer.innerHTML = '';
    
    if (filteredUsers.length === 0) {
        listContainer.innerHTML = `<div class="data-small" style="padding: 10px 15px;">Username '${searchInput}' tidak ditemukan.</div>`;
        return;
    }

    filteredUsers.forEach(user => {
        const item = document.createElement('div');
        item.className = 'user-item';
        item.innerHTML = `
            <strong>${user.username}</strong>
            <span>${user.numChildren} anak</span>
        `;
        listContainer.appendChild(item);
    });
}

// --- NAVIGATION ---
function hideAllSections() {
    document.querySelectorAll('.content-section').forEach(section => {
        section.style.display = 'none';
    });
}

function navigateTo(targetId) {
    hideAllSections();
    if (targetId === 'home') {
        document.getElementById('inputSection').style.display = 'block';
        document.getElementById('chartCard').style.display = 'block';
        document.getElementById('aboutSection').style.display = 'block';
    } else if (targetId === 'imunisasi') {
        document.getElementById('imunisasiSection').style.display = 'block';
        renderImunisasiTable();
    } else if (targetId === 'dashboard' && currentRole === 'admin') {
        document.getElementById('adminDashboard').style.display = 'block';
        renderAdminStats();
    } else if (targetId === 'about') { // Perbaikan navigasi 'Tentang'
        document.getElementById('aboutSection').style.display = 'block';
    }
    
    // Smooth scroll ke section yang dituju
    const targetElement = document.getElementById(targetId + 'Section') || document.getElementById(targetId);
    if (targetElement) {
         targetElement.scrollIntoView({ behavior: 'smooth', block: 'start' });
    }

    closeSidebar();
}


// --- RENDER FUNCTIONS (MASTER) ---

function renderAllData() {
    renderChildSelector();
    renderAuth(); 
    renderWho(); 
    renderList(); 
    renderChart();
    renderImunisasiTable(); // Panggil render imunisasi
    
    // Tampilkan link imunisasi jika user login
    imunisasiLink.style.display = (currentUser && currentRole === 'user') ? 'flex' : 'none';
    
    // Atur tampilan awal ke home
    const activeSection = document.getElementById('mainContent').querySelector('.content-section[style*="block"]');
    if (!activeSection) {
        navigateTo(currentRole === 'admin' ? 'dashboard' : 'home');
    }
}

function renderAuth(){ 
  const accountArea = document.getElementById('accountArea');
  if(currentUser){ 
    accountArea.innerHTML = `<div style="font-weight:700">${currentUser}</div><div class="data-small">${currentRole}</div>`; 
    document.getElementById('btnLogout').style.display='block'; 
    document.querySelectorAll('.menu-login').forEach(x=>x.style.display='none'); 
  } else { 
    accountArea.innerHTML = '<button id="authHeaderBtn" style="background: white; color: var(--primary); font-weight: 700; padding: 8px 14px; border-radius: 6px; box-shadow: none;">Login</button>'; 
    document.getElementById('authHeaderBtn')?.addEventListener('click', (e)=>{ e.preventDefault(); openAuth('login'); }); 
    document.getElementById('btnLogout').style.display='none'; 
    document.querySelectorAll('.menu-login').forEach(x=>x.style.display='block'); 
  }
  
  // Toggle Admin Dashboard visibility
  const adminLinks = document.querySelectorAll('.admin-only');
  adminLinks.forEach(el=> el.style.display = (currentRole==='admin')? 'block' : 'none');
}

function renderWho(){ 
    let childName = '';
    const childData = getCurrentChildData();
    if (childData) {
        const ageDetail = calculateAge(childData.dob);
        const genderText = childData.gender === 'male' ? 'L' : 'P';
        childName = `${childData.name} (${genderText} | ${formatAge(ageDetail)}) - Tgl Lahir: ${childData.dob}`;
    }

    document.getElementById('whoInfo').innerText = currentUser 
        ? `Masuk sebagai ${currentUser} (${currentRole})${currentRole === 'user' ? (childName ? ` | Data Aktif: ${childName}` : ' | Belum ada data anak.') : ''}` 
        : 'Belum login'; 
}


// Input save
document.getElementById('btnSave').addEventListener('click', async ()=>{
  // Tambahkan Loading State
  const btnSave = document.getElementById('btnSave');
  const originalText = btnSave.innerHTML;
  btnSave.disabled = true;
  btnSave.innerHTML = '<span class="loading-spinner"></span> Menyimpan...';

  try {
      // 1. Validasi Awal
      if(!currentUser || currentRole === 'admin'){ showSnackbar('Silakan login sebagai user biasa untuk menyimpan data', 'error'); return; }
      if(!currentChildId){ showSnackbar('Silakan pilih atau tambahkan data anak terlebih dahulu.', 'error'); return; }

      // 2. Ambil Data Anak Aktif 
      const users = getUsers(); 
      const childData = users[currentUser]?.children?.[currentChildId];

      if (!childData) { showSnackbar('Data anak aktif tidak ditemukan.', 'error'); return; }

      // 3. Ambil Input Form
      const tinggi = document.getElementById('tinggi').value; 
      const berat = document.getElementById('berat').value; 
      const catatan = document.getElementById('catatan').value.trim(); 
      
      // 4. Validasi Input Data
      if(!tinggi || !berat){ showSnackbar('Lengkapi data penting (Tinggi & Berat)', 'error'); return; }
      
      // Simulasi delay penyimpanan
      await new Promise(resolve => setTimeout(resolve, 500)); 
      
      // 5. Pembentukan Objek Data Baru
      const ageDetail = calculateAge(childData.dob);
      const entry = { 
        id: Date.now(), 
        tanggal_input: new Date().toISOString().split('T')[0],
        usia_bulan: ageDetail.totalMonths, // Gunakan totalMonths yang sudah dibulatkan untuk chart
        usia_format: formatAge(ageDetail), // Gunakan format string untuk display
        tinggi: Number(tinggi), 
        berat: Number(berat), 
        catatan: catatan
      };
      
      // 6. Proses Penyimpanan ke Local Storage
      if (!users[currentUser].children[currentChildId].data) {
          users[currentUser].children[currentChildId].data = [];
      }

      users[currentUser].children[currentChildId].data.push(entry); 
      saveUsers(users); 
      showSnackbar('Data perkembangan tersimpan', 'success'); 
      
      // 7. Render Ulang UI dan Bersihkan Form
      renderList(); 
      renderChart(); 
      
      document.getElementById('tinggi').value=''; 
      document.getElementById('berat').value=''; 
      document.getElementById('catatan').value=''; 
  } catch (error) {
       showSnackbar('Terjadi kesalahan saat menyimpan data.', 'error');
       console.error(error);
  } finally {
      // Hilangkan Loading State
      btnSave.disabled = false;
      btnSave.innerHTML = originalText;
  }
});

// Show Detail Modal (New Function)
function showDetail(id) {
    const childData = getCurrentChildData();
    if (!childData) return;

    const entry = childData.data.find(e => e.id === id);
    if (!entry) return;

    // Hitung status gizi
    const statusResult = getGrowthStatus(entry.tinggi, entry.berat, childData.gender);
    const genderText = childData.gender === 'male' ? 'Laki-laki' : 'Perempuan';

    // Isi Modal
    document.getElementById('detailChildName').innerText = `(${childData.name})`;
    document.getElementById('detailTanggal').innerText = entry.tanggal_input;
    document.getElementById('detailUsia').innerText = entry.usia_format;
    document.getElementById('detailGender').innerText = genderText;
    document.getElementById('detailTinggi').innerText = `${entry.tinggi} cm`;
    document.getElementById('detailBerat').innerText = `${entry.berat} kg`;
    document.getElementById('detailStatus').innerHTML = `<span class="status-badge ${statusResult.class}">${statusResult.status}</span>`;
    document.getElementById('detailCatatan').innerText = entry.catatan || '‚Äî Tidak ada catatan ‚Äî';
    
    // Set fungsi hapus
    document.getElementById('detailDeleteBtn').onclick = () => deleteEntry(id);

    openModal(detailModal);
}


// Data list (grid)
function renderList(){ 
  const list = document.getElementById('dataList'); list.innerHTML=''; 
  if(!currentUser || currentRole === 'admin'){ list.innerHTML = '<div class="data-small">Login sebagai user untuk melihat riwayat data.</div>'; return; } 
  if(!currentChildId){ list.innerHTML = '<div class="data-small">Silakan tambahkan data anak di menu "Atur Anak".</div>'; return; }

  const users = getUsers(); 
  const childData = users[currentUser].children[currentChildId];
  const entries = childData?.data || []; 
  
  if(!entries.length) { list.innerHTML = '<div class="data-small">Belum ada data perkembangan untuk anak ini.</div>'; return; }
  
  entries.slice().reverse().forEach(e=>{ 
    
    const d = document.createElement('div'); d.className = 'card-grid'; 
    d.setAttribute('onclick', `showDetail(${e.id})`); // Tambahkan listener detail

    // Tentukan status gizi untuk riwayat ini
    const statusResult = getGrowthStatus(e.tinggi, e.berat, childData.gender);
    const statusBadge = `<span class="status-badge ${statusResult.class}" style="margin-top: 0; margin-bottom: 0;">${statusResult.status}</span>`;

    d.innerHTML = `
        <div class="placeholder-icon" title="Riwayat Data">
            <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12C2 6.47715 6.47715 2 12 2Z"/><path d="M12 8V16"/><path d="M8 12H16"/></svg>
        </div>
        <div class="info">
            <strong>${childData.name}</strong>
            ${statusBadge}
            <div class="meta">${e.usia_format}</div>
            <div class="meta">${e.tinggi} cm ‚Ä¢ ${e.berat} kg</div>
            <div class="meta data-small">Tgl Input: ${e.tanggal_input}</div>
            <button class="delete-btn" onclick="event.stopPropagation(); deleteEntry(${e.id});">üóëÔ∏è Hapus</button>
        </div>`; 
    list.appendChild(d); 
  }); 
}

// Chart ‚Äî Chart.js
let chart = null;
function renderChart(){
  try{
    const canvas = document.getElementById('growthChart');
    const statusEl = document.getElementById('growthStatus');
    
    const existing = Chart.getChart(canvas);
    if(existing){ existing.destroy(); }
    
    const ctx = canvas.getContext('2d');
    if(!ctx) return;

    if(!currentUser || currentRole === 'admin' || !currentChildId){
      statusEl.innerText = 'Data Tidak Tersedia';
      statusEl.className = 'status-badge'; 
      chart = new Chart(ctx, {
        type: 'line',
        data: { labels: ['0'], datasets: [ { label: 'Tinggi (cm)', data: [0], borderColor: '#d1d5db', tension: 0.4 } ] },
        options: { 
            responsive: true, maintainAspectRatio: false,
            plugins: { legend: { display: false }, title: { display: true, text: 'Login atau Pilih Anak untuk melihat grafik' } },
            scales: { x: { display: true, title: { display: true, text: 'Usia (bulan)' } }, y: { beginAtZero: true, title: { display: true, text: 'Nilai' } } }
        }
      });
      return;
    }

    const childData = getCurrentChildData();
    const data = (childData.data) ? childData.data.slice() : [];
    const gender = childData.gender || 'male'; // Default ke male jika tidak ada

    // Urutkan data berdasarkan usia bulan untuk plotting yang benar pada sumbu X
    data.sort((a,b)=>a.usia_bulan - b.usia_bulan); 
    
    // Pastikan data yang akan diplot memiliki usia (bulan)
    const validData = data.filter(d => d.usia_bulan !== null && d.usia_bulan >= 0);


    if(!validData.length){
      statusEl.innerText = 'Belum ada data untuk anak ini';
      statusEl.className = 'status-badge';
      chart = new Chart(ctx, { 
        type: 'line',
        data: { labels: ['0'], datasets: [ { label: 'Tinggi (cm)', data: [0], borderColor: '#d1d5db', tension: 0.4 } ] },
        options: { 
            responsive: true, maintainAspectRatio: false, 
            plugins: { title: { display: true, text: 'Belum ada data pertumbuhan' } },
            scales: { x: { display: true, title: { display: true, text: 'Usia (bulan)' } }, y: { beginAtZero: true, title: { display: true, text: 'Nilai' } } }
        }
      });
      return;
    }
    
    // Tampilkan status gizi terbaru
    const latestEntry = validData[validData.length - 1];
    const statusResult = getGrowthStatus(latestEntry.tinggi, latestEntry.berat, gender);
    statusEl.innerText = `Status Terbaru: ${statusResult.status} (Berdasarkan WHO ${gender==='male'?'Laki-laki':'Perempuan'})`;
    statusEl.className = `status-badge ${statusResult.class}`;

    // --- SETUP DATASET GRAFIK ---
    const whoData = WHO_SIMULATED_DATA;
    const genderWeightData = whoData.weight[gender] || whoData.weight.male; // Ambil data WHO sesuai gender
    
    // Data Anak
    const userWeightData = validData.map(d => ({ x: d.usia_bulan, y: d.berat }));
    const userHeightData = validData.map(d => ({ x: d.usia_bulan, y: d.tinggi }));

    // Data Standar WHO (Simulasi)
    const whoLabels = genderWeightData.labels;
    const whoWeightMedian = whoData.weight[gender].median.map((y, i) => ({ x: whoLabels[i], y: y }));
    const whoWeightSDp2 = whoData.weight[gender].sd_plus2.map((y, i) => ({ x: whoLabels[i], y: y }));
    const whoWeightSDm2 = whoData.weight[gender].sd_minus2.map((y, i) => ({ x: whoLabels[i], y: y }));

    // Karena data height simulation dihilangkan, kita gunakan weight data untuk kedua sumbu, ini harus diperbaiki di masa depan
    // For now, we will use a simple linear progression for height standards as a placeholder to keep the chart dual-axis functional
    const whoHeightMedian = whoData.weight[gender].median.map((y, i) => ({ x: whoLabels[i], y: y * 6.5 })); // PLACEHOLDER
    const whoHeightSDp2 = whoData.weight[gender].sd_plus2.map((y, i) => ({ x: whoLabels[i], y: y * 6.5 + 5 })); // PLACEHOLDER
    const whoHeightSDm2 = whoData.weight[gender].sd_minus2.map((y, i) => ({ x: whoLabels[i], y: y * 6.5 - 5 })); // PLACEHOLDER

    const allDataPoints = [...userWeightData, ...userHeightData, ...whoWeightSDp2, ...whoHeightSDp2];
    const maxUsia = Math.max(...allDataPoints.map(d => d.x), 24);
    const maxValWeight = Math.max(...[...userWeightData, ...whoWeightSDp2].map(d => d.y));
    const maxValHeight = Math.max(...[...userHeightData, ...whoHeightSDp2].map(d => d.y));

    chart = new Chart(ctx, {
      type: 'line',
      data: {
        datasets: [
          // DATA ANAK (Primary)
          { 
            label: `Berat ${childData.name} (kg)`, 
            data: userWeightData, 
            borderColor: '#ff8c42', 
            backgroundColor: 'rgba(255,140,66,0.5)', 
            tension: 0.2, 
            fill: false,
            pointRadius: 6,
            pointHoverRadius: 8,
            pointStyle: 'circle',
            yAxisID: 'yWeight',
            order: 1
          },
          { 
            label: `Tinggi ${childData.name} (cm)`, 
            data: userHeightData, 
            borderColor: '#4f46e5', 
            backgroundColor: 'rgba(79,70,229,0.5)', 
            tension: 0.2, 
            fill: false,
            pointRadius: 6,
            pointHoverRadius: 8,
            pointStyle: 'triangle',
            yAxisID: 'yHeight',
            order: 2
          },
          // GARIS STANDAR WHO (Secondary - Berat)
          { label: 'WHO Median BB', data: whoWeightMedian, borderColor: '#ff8c42', borderDash: [5, 5], borderWidth: 1, tension: 0.4, fill: false, pointRadius: 0, yAxisID: 'yWeight', order: 3 },
          { label: 'WHO +2 SD BB', data: whoWeightSDp2, borderColor: '#f44336', borderWidth: 1, tension: 0.4, fill: false, pointRadius: 0, yAxisID: 'yWeight', order: 4 },
          { label: 'WHO -2 SD BB', data: whoWeightSDm2, borderColor: '#f44336', borderWidth: 1, tension: 0.4, fill: false, pointRadius: 0, yAxisID: 'yWeight', order: 5 },
          // GARIS STANDAR WHO (Secondary - Tinggi)
          { label: 'WHO Median TB (Placeholder)', data: whoHeightMedian, borderColor: '#4f46e5', borderDash: [5, 5], borderWidth: 1, tension: 0.4, fill: false, pointRadius: 0, yAxisID: 'yHeight', order: 6 },
          { label: 'WHO +2 SD TB (Placeholder)', data: whoHeightSDp2, borderColor: '#10b981', borderWidth: 1, tension: 0.4, fill: false, pointRadius: 0, yAxisID: 'yHeight', order: 7 },
          { label: 'WHO -2 SD TB (Placeholder)', data: whoHeightSDm2, borderColor: '#10b981', borderWidth: 1, tension: 0.4, fill: false, pointRadius: 0, yAxisID: 'yHeight', order: 8 },
        ]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            tooltip: { mode: 'index', intersect: false, bodyFont: { size: 14 }, titleFont: { size: 15 } },
            legend: { position: 'bottom', labels: { boxWidth: 12, font: { size: 12 } } },
            title: { display: true, text: `Grafik Pertumbuhan ${childData.name} (${gender==='male'?'Laki-laki':'Perempuan'}) vs. Standar WHO`, font: { size: 16 } }
        },
        scales: {
          x: {
              type: 'linear', // Ubah tipe sumbu X menjadi linear (angka)
              min: 0,
              max: Math.ceil(maxUsia / 6) * 6, // Pembulatan ke atas kelipatan 6
              title: { display: true, text: 'Usia Anak (Bulan)', font: { size: 14, weight: 'bold' } }, 
              ticks: { stepSize: 3, font: { size: 12 } }
          },
          yWeight: {
              type: 'linear',
              position: 'left',
              beginAtZero: true,
              max: Math.ceil(maxValWeight * 1.1 / 5) * 5, // Auto Max
              title: { display: true, text: 'Berat Badan (kg)', font: { size: 14, weight: 'bold' }, color: '#ff8c42' }, 
              ticks: { font: { size: 12 }, color: '#ff8c42' }
          },
          yHeight: {
              type: 'linear',
              position: 'right',
              beginAtZero: false,
              grid: { drawOnChartArea: false }, // Jangan tampilkan garis grid untuk sumbu kanan
              max: Math.ceil(maxValHeight * 1.1 / 10) * 10, // Auto Max
              title: { display: true, text: 'Tinggi Badan (cm)', font: { size: 14, weight: 'bold' }, color: '#4f46e5' }, 
              ticks: { font: { size: 12 }, color: '#4f46e5' }
          }
        }
      }
    });
  }catch(err){
    console.error('renderChart error', err);
    showSnackbar('Gagal memuat grafik. Cek konsol.', 'error');
  }
}

// --- EXPORT FUNCTION ---
document.getElementById('btnExportCSV').addEventListener('click', () => {
    if (!currentUser || currentRole === 'admin' || !currentChildId) {
        showSnackbar('Login sebagai user dan pilih anak untuk ekspor data.', 'error');
        return;
    }

    const childData = getCurrentChildData();
    const data = childData.data || [];

    if (data.length === 0) {
        showSnackbar('Tidak ada data yang bisa diekspor.', 'warning');
        return;
    }

    // Filter data untuk CSV
    const dataToExport = data.map(entry => {
        const { id, usia_bulan, ...rest } = entry;
        return rest;
    });

    const csv = Papa.unparse(dataToExport);

    const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement('a');
    
    const filename = `FARESTA_Data_${childData.name.replace(/\s/g, '_')}_${new Date().toISOString().split('T')[0]}.csv`;
    
    link.href = URL.createObjectURL(blob);
    link.setAttribute('download', filename);
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    
    showSnackbar('Data berhasil diunduh dalam format CSV', 'success');
});


// --- FORGOT PASSWORD LOGIC ---
function forgotPassword() {
    const user = document.getElementById('forgotUser').value.trim();
    const newPass = document.getElementById('forgotNewPass').value;

    if (!user || !newPass) {
        showSnackbar('Username dan Password Baru harus diisi.', 'error');
        return;
    }

    const users = getUsers();
    
    // Periksa apakah username ada (kecuali admin)
    if (user === 'admin') {
        showSnackbar('Password Admin tidak dapat direset melalui fitur ini.', 'error');
        return;
    }
    
    if (users[user]) {
        users[user].password = newPass;
        saveUsers(users);
        showSnackbar(`Password untuk ${user} berhasil direset!`, 'success');
        document.getElementById('forgotUser').value = '';
        document.getElementById('forgotNewPass').value = '';
        closeModal(forgotPasswordModal);
        openAuth('login');
    } else {
        showSnackbar('Username tidak ditemukan.', 'error');
    }
}


// --- INIT LISTENERS ---
function initListeners() {
    // Sidebar Navigation:
    sidebarBtn.addEventListener('click', (e)=>{ e.stopPropagation(); if(sidebar.classList.contains('open')) closeSidebar(); else openSidebar(); });
    document.getElementById('openAuth').addEventListener('click', (e)=>{ e.preventDefault(); openAuth('login'); closeSidebar(); });
    
    // Navigate via Sidebar links
    document.querySelectorAll('[data-nav]').forEach(link => {
        link.addEventListener('click', (e) => {
            e.preventDefault();
            const targetId = e.currentTarget.getAttribute('href').substring(1);
            if (targetId) {
                navigateTo(targetId);
            }
        });
    });

    
    // Auth Modal Switches:
    document.getElementById('showRegister').addEventListener('click', ()=> openAuth('register'));
    document.getElementById('showLogin').addEventListener('click', ()=> openAuth('login'));
    
    // Forgot Password Link
    document.getElementById('showForgotPassword').addEventListener('click', (e) => {
        e.preventDefault();
        closeModal(authModal);
        openModal(forgotPasswordModal);
    });
    
    // Forgot Password Actions
    document.getElementById('btnResetPass').addEventListener('click', forgotPassword);
    document.getElementById('cancelReset').addEventListener('click', () => {
        closeModal(forgotPasswordModal);
        openAuth('login');
    });

    
    // Auth Actions:
    document.getElementById('btnRegister').addEventListener('click', ()=>{
      const u = document.getElementById('regUser').value.trim(); const p = document.getElementById('regPass').value; if(!u||!p){ showSnackbar('Isi username & password', 'error'); return; }
      const users = getUsers(); if(users[u]){ showSnackbar('Username sudah ada', 'error'); return; }
      // Skema baru: Pastikan children diinisialisasi saat register
      users[u] = { password: p, children: {} }; 
      saveUsers(users); showSnackbar('Akun dibuat ‚Äî silakan login', 'success'); openAuth('login'); document.getElementById('regUser').value=''; document.getElementById('regPass').value='';
      renderAdminStats(); 
    });
    
    // FUNGSI btnLogin
    document.getElementById('btnLogin').addEventListener('click', ()=>{
      const u = document.getElementById('loginUser').value.trim(); const p = document.getElementById('loginPass').value; if(!u||!p){ showSnackbar('Isi username & password', 'error'); return; }
      const users = getUsers(); 
      
      let newChildId = null;

      if(u==='admin' && p==='admin123'){ 
        currentUser='admin'; 
        currentRole='admin'; 
      } else if(users[u] && users[u].password === p) {
        currentUser = u; 
        currentRole = 'user';
        // Pastikan children ada, jika tidak ada, buat objek kosong
        users[u].children = users[u].children || {}; 
        // Ambil ID anak pertama jika ada, untuk default sesi
        newChildId = Object.keys(users[u].children || {})[0] || null;
      } else {
        showSnackbar('Username / password salah', 'error'); return; 
      }
      
      currentChildId = newChildId;
      saveSession(currentUser, currentRole, currentChildId);
      closeModal(authModal); closeSidebar(); renderAllData(); showSnackbar('Login berhasil', 'success');
    });
    
    document.getElementById('btnLogout').addEventListener('click', ()=>{ 
        clearSession(); 
        currentUser=null; 
        currentRole=null;
        currentChildId=null;
        renderAllData(); 
        showSnackbar('Logout berhasil', 'info'); 
    });
}

// initial load and setup
document.addEventListener('DOMContentLoaded', () => {
    loadSession(); // MEMUAT SESI DARI LOCAL STORAGE
    initListeners();
    renderAllData();
});

// Ensure chart re-renders on resize 
window.addEventListener('resize', ()=> {
    setTimeout(renderChart, 100); 
});
</script>
</body>
  </html>
