<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>FARESTA ‚Äî Laporan Tumbuh Kembang</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<style>
:root{
  --primary: #4f46e5; /* Tailwind indigo-600 */
  --primary-light: #6366f1; /* Tailwind indigo-500 */
  --primary-bg: #eef2ff; /* Tailwind indigo-50 */
  --muted: #6b7280;
  --card: #fff;
  --bg: #f3f4f6; /* Lighter background */
  --shadow-sm: 0 1px 3px rgba(0,0,0,0.08);
  --shadow-md: 0 4px 6px rgba(0,0,0,0.1);
  --success: #10b981; /* Tailwind emerald-500 */
  --error: #ef4444; /* Tailwind red-500 */
}
*{box-sizing:border-box}
html,body{height:100%;margin:0;font-family:Inter,system-ui,-apple-system,'Segoe UI',Roboto,Arial;color:#1f2937;background:var(--bg)}

/* --- Sidebar --- */
#sidebarBtn{position:fixed;top:16px;left:16px;z-index:140;background:var(--primary);color:#fff;border:0;padding:10px;border-radius:12px;cursor:pointer;box-shadow:var(--shadow-md); transition: transform .3s ease;}
#sidebarBtn:hover{transform: scale(1.05);}
#sidebar{position:fixed;top:16px;left:16px;width:200px;background:var(--primary);border-radius:12px;padding:8px;box-shadow:0 10px 30px rgba(15,23,42,.15);transform:translateX(-250px);transition:transform .3s cubic-bezier(0.68, -0.55, 0.265, 1.55);z-index:130}
#sidebar.open{transform:translateX(0)}
#sidebar .panel{background:#fff;color:#1f2937;border-radius:10px;padding:10px;margin-top:8px;box-shadow:var(--shadow-sm)}
#sidebar h3{margin:0 0 6px;font-size:14px;color:#fff}
#sidebar a{display:flex;align-items:center;gap:8px;padding:10px;border-radius:8px;text-decoration:none;color:#1f2937;margin-bottom:6px;background:var(--primary-bg);font-weight:600;transition:background .15s ease}
#sidebar a:hover{background:#dbeafe}
#sidebar a.admin-only{display:none}
#overlay{position:fixed;inset:0;background:rgba(0,0,0,0.18);z-index:120;display:none;opacity:0;transition:opacity .3s ease}
#overlay.show{display:block;opacity:1}

/* --- Layout --- */
.container{
    max-width:1200px;
    margin:24px auto; 
    padding:16px;
}
/* PERBAIKAN FOKUS: Menghapus properti background white dari .card, dan memastikan teks di header jelas */
.header{
    background:linear-gradient(135deg,var(--primary),var(--primary-light));
    padding:28px;
    border-radius:16px;
    color:#fff; /* Teks harus putih */
    display:flex;
    gap:20px;
    align-items:center;
    box-shadow:var(--shadow-md); 
    margin-bottom: 20px;
} 
.header .title{font-size:24px;font-weight:700}
.header .subtitle{opacity:.9;font-size:15px}
.row{display:grid;grid-template-columns:1fr 360px;gap:20px;margin-top:0} 
.card{
    background:var(--card);
    padding:20px; 
    border-radius:12px;
    box-shadow:var(--shadow-md);
    border: 1px solid #e5e7eb; /* Tambah border halus untuk definisi */
}
.card h4 {
    font-size: 18px; 
    margin-top: 0;
    margin-bottom: 15px; 
    font-weight: 700;
}

/* --- Elements --- */
.field{margin-top:14px} 
label{display:block;margin-bottom:4px;font-weight:600;font-size:15px; color:#1f2937} 
input:not([type="file"]),textarea,select{
    width:100%;
    padding:10px 12px; 
    border-radius:8px; 
    border:1px solid #d1d5db;
    background:#fff;
    font-size:15px; 
    margin-bottom: 5px; 
    transition:border-color .2s ease
}
input:focus,textarea:focus,select:focus{border-color:var(--primary);outline:none}
button{background:var(--primary);color:#fff;padding:12px 18px;border-radius:8px;border:0;cursor:pointer;font-weight:600;transition:background .2s ease;font-size:15px;box-shadow:0 2px 4px rgba(0,0,0,0.1)} 
button:hover{background:var(--primary-light)}
button.ghost{background:transparent;color:var(--primary);border:1px solid var(--primary-bg);box-shadow:none}
button.ghost:hover{background:var(--primary-bg)}

/* --- Data Grid (Riwayat) --- */
.grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(180px,1fr));gap:14px} 
.card-grid{background:#fff;border-radius:10px;padding:10px;box-shadow:var(--shadow-sm);display:flex;flex-direction:column;align-items:stretch;border:1px solid #e5e7eb; cursor: pointer;} 
.card-grid img{
    width:100%;
    height:160px; 
    object-fit: contain; 
    border-radius:8px;
    margin-bottom:8px;
    background-color: #f8fafc; 
    border: 1px solid #f3f4f6;
}
.card-grid .info{padding:4px}
.card-grid strong{font-size:16px; color:#1f2937;} 
.card-grid .meta{color:var(--muted);font-size:14px;line-height:1.4} 
.data-small{font-size:14px;color:var(--muted)} 
.delete-btn {
    background: var(--error);
    color: white;
    padding: 8px 12px; 
    border-radius: 6px;
    font-size: 14px; 
    margin-top: 8px;
    width: 100%;
    transition: background .2s ease;
}
.delete-btn:hover { background: #cc3333; }

/* Admin Dashboard styles */
.admin-stats {
    display: flex;
    gap: 16px; 
    margin-top: 16px;
}
.stat-box {
    flex: 1;
    padding: 16px; 
    border-radius: 10px;
    background: var(--primary-bg);
    border: 1px solid #e0e7ff;
    text-align: center;
}
.stat-box .count {
    font-size: 30px; 
    font-weight: 700;
    color: var(--primary);
}
.stat-box .label {
    font-size: 14px; 
    color: var(--muted);
    margin-top: 4px;
}

/* --- Modal --- */
.modal{position:fixed;left:50%;top:50%;transform:translate(-50%,-50%);z-index:200;background:#fff;padding:24px;border-radius:16px;box-shadow:0 20px 50px rgba(15,23,42,.25);width:360px;max-width:94vw;display:none;opacity:0;transition:opacity .3s ease, transform .3s ease}
.modal.open{display:block;opacity:1;transform:translate(-50%,-50%)}
.modal h4{margin:0 0 10px;font-size:18px}
.modal #loginBlock, .modal #registerBlock { display: flex; flex-direction: column; gap: 8px;} 

/* Modal Preview Gambar */
#imagePreviewModal {
    width: auto;
    max-width: 80vw;
    padding: 10px;
    background: rgba(0,0,0,0.85); 
}
#imagePreviewModal.open {
    display: flex;
    justify-content: center;
    align-items: center;
    inset: 0; 
    transform: none;
    top: 0;
    left: 0;
}
#imagePreviewModal img {
    max-width: 100%;
    max-height: 90vh;
    border-radius: 8px;
    object-fit: contain;
    background: #fff;
    padding: 5px;
}


/* --- Chart --- */
.chart-box{height:300px;margin-top:10px} 

/* --- Toast Notification --- */
#toastContainer{position:fixed;top:20px;right:20px;z-index:1000} 
.toast{background:var(--card);color:#333;padding:12px 18px;border-radius:8px;box-shadow:0 6px 16px rgba(0,0,0,0.15);margin-bottom:10px;display:flex;align-items:center;gap:12px;opacity:0;transform:translateX(100%);transition:opacity .3s ease, transform .3s ease}
.toast.show{opacity:1;transform:translateX(0)}
.toast .icon{font-size:20px;line-height:1;margin-top:-2px}
.toast .message{font-weight:600;font-size:15px} 

/* --- Responsive --- */
@media(max-width:980px){
  .row{grid-template-columns:1fr; gap: 16px;}
  .header{flex-direction:column;align-items:flex-start}
  .container{padding: 16px;} 
  .card{padding:18px;} 
  #sidebar{width:180px}
  #toastContainer{right:10px;top:10px}
  .admin-stats { flex-direction: column; }
}

/* Khusus input file agar tidak terlalu kecil di mobile */
input[type="file"] {
    font-size: 14px;
    padding: 8px 0;
}
</style>
</head>
<body>

<button id="sidebarBtn" title="Menu">
    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
        <path d="M4 6H20M4 12H20M4 18H20" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
    </svg>
</button>
<div id="sidebar" aria-hidden="true">
  <div style="display:flex;align-items:center;gap:10px;padding:8px 10px;color:#fff;font-size:18px">
    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M12 2C6.477 2 2 6.477 2 12C2 17.523 6.477 22 12 22C17.523 22 22 17.523 22 12C22 6.477 17.523 2 12 2Z" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><path d="M12 16C14.2091 16 16 14.2091 16 12C16 9.79086 14.2091 8 12 8C9.79086 8 8 9.79086 8 12C8 14.2091 9.79086 16 12 16Z" fill="white" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
    <div style="font-weight:700">FARESTA</div>
  </div>
  <div class="panel" id="sidebarPanel" style="display:none">
    <a href="#home" data-nav>üè° Beranda</a>
    <a href="#" id="openAuth" class="menu-login">üîë Login / Register</a>
    <a href="#dashboard" data-nav id="adminLink" class="admin-only">‚öôÔ∏è Dashboard Admin</a>
    <a href="#about" data-nav>üí° Tentang</a>
    <a href="#" id="btnLogout" style="display:none">üö™ Logout</a>
  </div>
</div>
<div id="overlay"></div>

<div id="toastContainer"></div>

<div class="container">
  <div class="header">
    <svg width="40" height="40" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12C2 6.47715 6.47715 2 12 2Z" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><path d="M12 16C14.2091 16 16 14.2091 16 12C16 9.79086 14.2091 8 12 8C9.79086 8 8 9.79086 8 12C8 14.2091 9.79086 16 12 16Z" fill="white" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
    <div>
      <div class="title">FARESTA ‚Äî Laporan Tumbuh Kembang</div>
      <div class="subtitle">Pantau perkembangan anak dengan mudah, simpan foto & grafik interaktif.</div>
    </div>
    <div style="margin-left:auto; text-align:right" id="accountArea"></div>
  </div>

  <div class="row">
    <main id="mainContent">
      <div class="card admin-only" id="adminDashboard" style="display:none; margin-bottom: 20px;">
        <h4>üìä Dashboard Admin</h4>
        <div class="admin-stats">
            <div class="stat-box">
                <div class="count" id="statUsers">0</div>
                <div class="label">Total User Terdaftar</div>
            </div>
            <div class="stat-box">
                <div class="count" id="statVisits">0</div>
                <div class="label">Total Kunjungan Website</div>
            </div>
        </div>
      </div>
      
      <div class="card" id="inputSection">
        <h4>Input Data Perkembangan Anak</h4>
        <div class="data-small" id="whoInfo">Belum login</div>

        <div class="field"><label for="nama">Nama Anak</label><input id="nama" placeholder="Cth: Budi" /></div>
        <div class="field"><label for="tanggalLahir">Tanggal Lahir</label><input id="tanggalLahir" type="date" /></div>
        <div class="field"><label for="usia">Usia (bulan)</label><input id="usia" placeholder="Akan terisi otomatis" type="number" min="0" readonly style="background: #f1f5f9; cursor: not-allowed;" /></div>
        <div class="field"><label for="tinggi">Tinggi (cm)</label><input id="tinggi" placeholder="Cth: 80.5" type="number" min="0" step="0.1" /></div>
        <div class="field"><label for="berat">Berat (kg)</label><input id="berat" placeholder="Cth: 10.2" type="number" min="0" step="0.1" /></div>
        <div class="field"><label for="catatan">Catatan Perkembangan</label><textarea id="catatan" placeholder="Cth: Sudah bisa berjalan tanpa pegangan..."></textarea></div>
        <div class="field" style="display:flex;gap:10px;align-items:center"><input id="foto" type="file" accept="image/*" style="flex-grow:1" /><button id="btnSave">üíæ Simpan Data</button></div>
      </div>

      <div class="card" id="chartCard" style="margin-top:20px">
        <h4>üìà Grafik Pertumbuhan Anak</h4>
        <div class="chart-box"><canvas id="growthChart" aria-label="Grafik pertumbuhan" role="img"></canvas></div>
      </div>

      <div class="card" id="about" style="margin-top:20px">
        <h4>üí° Tentang FARESTA</h4>
        <p style="line-height:1.6; font-size: 15px;">FARESTA membantu orang tua menyimpan catatan tumbuh kembang anak, melihat grafik perkembangan, dan menyimpan foto untuk setiap catatan. Data disimpan secara lokal di browser Anda (LocalStorage) sehingga aman dan cepat.</p>
      </div>
    </main>

    <aside id="asideContent">
      <div class="card" id="authCard">
        <h4>Data Tersimpan (Riwayat)</h4>
        <div id="dataList" class="grid"></div>
      </div>
    </aside>
  </div>
</div>

<div id="authModal" class="modal" aria-hidden="true">
  <h4 id="authTitle">Login</h4>
  <div id="loginBlock">
    <input id="loginUser" placeholder="Username">
    <input id="loginPass" placeholder="Password" type="password">
    <div style="display:flex;gap:8px;margin-top:8px"><button id="btnLogin" style="flex-grow:1">Login</button><button id="showRegister" class="ghost">Register</button></div>
  </div>
  <div id="registerBlock" style="display:none">
    <input id="regUser" placeholder="Username">
    <input id="regPass" placeholder="Password" type="password">
    <div style="display:flex;gap:8px;margin-top:8px"><button id="btnRegister" style="flex-grow:1">Buat Akun</button><button id="showLogin" class="ghost">Kembali</button></div>
  </div>
</div>

<div id="imagePreviewModal" class="modal" aria-hidden="true" onclick="closeImagePreview()">
    <img id="previewImage" src="" alt="Preview Gambar Riwayat">
</div>


<script>
// --- GLOBAL CONSTANTS & HELPERS ---
const USERS_KEY = 'faresta_users_v3';
const VISIT_COUNT_KEY = 'faresta_visit_count_v1';
const getUsers = ()=> JSON.parse(localStorage.getItem(USERS_KEY) || '{}');
const saveUsers = u=> localStorage.setItem(USERS_KEY, JSON.stringify(u));
let currentUser = null; 
let currentRole = null; 

// --- VISIT COUNTER ---
function countVisit() {
    let count = parseInt(localStorage.getItem(VISIT_COUNT_KEY) || '0');
    count += 1;
    localStorage.setItem(VISIT_COUNT_KEY, count);
}

// --- INITIAL SETUP: Ensure Admin Exists ---
(function(){ 
    const u=getUsers(); 
    if(!u.admin){ 
        u.admin={password:'admin123',data:[]}; 
        saveUsers(u); 
    }
    countVisit(); 
})();


// --- TOAST NOTIFICATION FUNCTION ---
function showToast(message, type = 'info') {
    const container = document.getElementById('toastContainer');
    const toast = document.createElement('div');
    toast.className = `toast ${type}`;
    let icon = '';
    if (type === 'success') icon = '‚úÖ';
    else if (type === 'error') icon = '‚ùå';
    else icon = 'üí°';
    
    toast.innerHTML = `<span class="icon">${icon}</span><span class="message">${message}</span>`;
    container.appendChild(toast);
    
    setTimeout(() => {
        toast.classList.add('show');
    }, 50);

    setTimeout(() => {
        toast.classList.remove('show');
        setTimeout(() => toast.remove(), 300); 
    }, 4000);
}

// --- IMAGE PREVIEW FUNCTIONS ---
const imagePreviewModal = document.getElementById('imagePreviewModal');
const previewImage = document.getElementById('previewImage');

function openImagePreview(src) {
    if (!src || src.includes('No Photo')) return; 
    previewImage.src = src;
    imagePreviewModal.classList.add('open');
    imagePreviewModal.setAttribute('aria-hidden', 'false');
}

function closeImagePreview() {
    imagePreviewModal.classList.remove('open');
    imagePreviewModal.setAttribute('aria-hidden', 'true');
    previewImage.src = ''; 
}

document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape' && imagePreviewModal.classList.contains('open')) {
        closeImagePreview();
    }
});


// --- AGE CALCULATION FUNCTION ---
function calculateAge(birthDate) {
    if (!birthDate) return null;
    const today = new Date();
    const dob = new Date(birthDate);

    let months = (today.getFullYear() - dob.getFullYear()) * 12;
    months -= dob.getMonth();
    months += today.getMonth();

    if (today.getDate() < dob.getDate()) {
        months -= 1;
    }

    return months > 0 ? months : 0;
}

// --- DATA ACTIONS ---
function deleteEntry(id) {
    if (!currentUser || currentRole === 'admin') {
        showToast('Aksi ditolak. Silakan login sebagai pengguna.', 'error');
        return;
    }
    
    const confirmation = confirm('Anda yakin ingin menghapus data ini? Aksi ini tidak dapat dibatalkan.');
    if (!confirmation) {
        return;
    }

    const users = getUsers();
    let data = users[currentUser]?.data || [];
    
    const initialLength = data.length;
    data = data.filter(entry => entry.id !== id);
    
    if (data.length === initialLength) {
        showToast('Data gagal ditemukan.', 'error');
        return;
    }

    users[currentUser].data = data;
    saveUsers(users);
    
    showToast('Data berhasil dihapus', 'success');
    renderList();
    renderChart();
}


// --- UI ELEMENTS ---
const sidebarBtn = document.getElementById('sidebarBtn');
const sidebar = document.getElementById('sidebar');
const sidebarPanel = document.getElementById('sidebarPanel');
const overlay = document.getElementById('overlay');
const authModal = document.getElementById('authModal');
const authTitle = document.getElementById('authTitle');
const adminDashboard = document.getElementById('adminDashboard');
const inputSection = document.getElementById('inputSection');

// Sidebar open/close
function openSidebar(){ sidebar.classList.add('open'); sidebarPanel.style.display='block'; overlay.classList.add('show'); }
function closeSidebar(){ sidebar.classList.remove('open'); sidebarPanel.style.display='none'; overlay.classList.remove('show'); }

// open auth modal
function openAuth(mode='login'){ authTitle.innerText = mode==='login' ? 'Login' : 'Register'; authModal.classList.add('open'); authModal.setAttribute('aria-hidden','false'); 
    document.getElementById('loginBlock').style.display=mode==='login' ? 'flex' : 'none'; 
    document.getElementById('registerBlock').style.display=mode==='register' ? 'flex' : 'none'; 
}
function closeAuth(){ authModal.classList.remove('open'); authModal.setAttribute('aria-hidden','true'); }

// --- ADMIN STATS ---
function getAdminStats() {
    const users = getUsers();
    const userCount = Object.keys(users).length; 
    const visitCount = parseInt(localStorage.getItem(VISIT_COUNT_KEY) || '0');
    return { userCount: userCount, visitCount: visitCount };
}

function renderAdminStats() {
    const stats = getAdminStats();
    document.getElementById('statUsers').innerText = stats.userCount;
    document.getElementById('statVisits').innerText = stats.visitCount;
}

// --- RENDER FUNCTIONS ---
function renderAuth(){ 
  const accountArea = document.getElementById('accountArea');
  if(currentUser){ 
    accountArea.innerHTML = `<div style="font-weight:700">${currentUser}</div><div class="data-small">${currentRole}</div>`; 
    document.getElementById('btnLogout').style.display='block'; 
    document.querySelectorAll('.menu-login').forEach(x=>x.style.display='none'); 
  } else { 
    // PERBAIKAN: Tombol Login di Header disesuaikan agar terlihat jelas dengan latar ungu
    accountArea.innerHTML = '<button id="authHeaderBtn" style="background: white; color: var(--primary); font-weight: 700; padding: 8px 14px; border-radius: 6px; box-shadow: none;">Login</button>'; 
    document.getElementById('authHeaderBtn')?.addEventListener('click', (e)=>{ e.preventDefault(); openAuth('login'); }); 
    document.getElementById('btnLogout').style.display='none'; 
    document.querySelectorAll('.menu-login').forEach(x=>x.style.display='block'); 
  }
  
  // Toggle Admin Dashboard visibility
  const adminLinks = document.querySelectorAll('.admin-only');
  adminLinks.forEach(el=> el.style.display = (currentRole==='admin')? 'block' : 'none');
  
  if (currentRole === 'admin') {
      inputSection.style.display = 'none';
      adminDashboard.style.display = 'block';
      renderAdminStats();
  } else {
      inputSection.style.display = 'block';
      adminDashboard.style.display = 'none';
  }
}

function renderWho(){ document.getElementById('whoInfo').innerText = currentUser ? `Masuk sebagai ${currentUser} (${currentRole})` : 'Belum login'; }


// Input save
async function fileToBase64(file){ return new Promise((res,rej)=>{ const r=new FileReader(); r.onload=()=>res(r.result); r.onerror=rej; r.readAsDataURL(file); }); }

document.getElementById('btnSave').addEventListener('click', async ()=>{
  if(!currentUser || currentRole === 'admin'){ showToast('Silakan login sebagai user biasa untuk menyimpan data', 'error'); return; }
  const nama = document.getElementById('nama').value.trim(); 
  const usia = document.getElementById('usia').value; 
  const tanggalLahir = document.getElementById('tanggalLahir').value; 
  const tinggi = document.getElementById('tinggi').value; 
  const berat = document.getElementById('berat').value; 
  const catatan = document.getElementById('catatan').value.trim(); 
  const fotoFile = document.getElementById('foto').files[0];
  
  if(!nama || !usia || !tinggi || !berat){ showToast('Lengkapi data penting (Nama, Usia, Tinggi, Berat)', 'error'); return; }
  
  const users = getUsers(); 
  const entry = { id:Date.now(), nama, usia:Number(usia), tanggalLahir, tinggi:Number(tinggi), berat:Number(berat), catatan, foto:null };
  
  if(fotoFile) {
      if(fotoFile.size > 2 * 1024 * 1024) { 
          showToast('Ukuran foto terlalu besar (Max 2MB)', 'error');
          return;
      }
      entry.foto = await fileToBase64(fotoFile);
  }
  
  users[currentUser].data.push(entry); 
  saveUsers(users); 
  showToast('Data perkembangan tersimpan', 'success'); 
  renderList(); 
  renderChart(); 
  
  // clear form
  document.getElementById('nama').value=''; 
  document.getElementById('usia').value=''; 
  document.getElementById('tanggalLahir').value=''; 
  document.getElementById('tinggi').value=''; 
  document.getElementById('berat').value=''; 
  document.getElementById('catatan').value=''; 
  document.getElementById('foto').value='';
});

// Data list (grid)
function renderList(){ 
  const list = document.getElementById('dataList'); list.innerHTML=''; 
  if(!currentUser){ list.innerHTML = '<div class="data-small">Login untuk melihat data tersimpan.</div>'; return; } 
  if(currentRole === 'admin'){ list.innerHTML = '<div class="data-small">Dashboard Admin tidak menampilkan riwayat data perkembangan.</div>'; return; }

  const users = getUsers(); 
  const entries = users[currentUser]?.data || []; 
  if(!entries.length) { list.innerHTML = '<div class="data-small">Belum ada data tersimpan.</div>'; return; }
  
  entries.slice().reverse().forEach(e=>{ 
    const fotoSrc = e.foto||'data:image/svg+xml;utf8,<svg xmlns=\"http://www.w3.org/2000/svg\" width=\"320\" height=\"180\" viewBox=\"0 0 320 180\"><rect width=\"100%\" height=\"100%\" fill=\"%23eef4ff\"/><text x=\"50%\" y=\"50%\" font-family=\"Inter\" font-size=\"24\" fill=\"%234f46e5\" text-anchor=\"middle\" dominant-baseline=\"middle\">No Photo</text></svg>';
    
    const d = document.createElement('div'); d.className = 'card-grid'; 
    d.innerHTML = `
        <img src="${fotoSrc}" alt="Foto ${e.nama}" onclick="openImagePreview('${fotoSrc}')">
        <div class="info">
            <strong>${e.nama}</strong>
            <div class="meta">${e.usia} bulan ‚Ä¢ ${e.tinggi} cm ‚Ä¢ ${e.berat} kg</div>
            <div class="meta">${e.tanggalLahir||'Tgl. Tidak Ada'}</div>
            <div style="margin-top:4px" class="data-small">${e.catatan||'Tidak ada catatan.'}</div>
            <button class="delete-btn" onclick="event.stopPropagation(); deleteEntry(${e.id});">üóëÔ∏è Hapus</button>
        </div>`; 
    list.appendChild(d); 
  }); 
}

// Chart ‚Äî Chart.js
let chart = null;
function renderChart(){
  try{
    const canvas = document.getElementById('growthChart');
    if(!canvas) return;

    const existing = Chart.getChart(canvas);
    if(existing){ existing.destroy(); }
    
    const ctx = canvas.getContext('2d');
    if(!ctx) return;

    if(!currentUser || currentRole === 'admin'){
      chart = new Chart(ctx, {
        type: 'line',
        data: { labels: ['0'], datasets: [ { label: 'Tinggi (cm)', data: [0], borderColor: '#d1d5db', tension: 0.4 }, { label: 'Berat (kg)', data: [0], borderColor: '#9ca3af', tension: 0.4 } ] },
        options: { 
            responsive: true, 
            maintainAspectRatio: false,
            plugins: { legend: { display: false }, title: { display: true, text: 'Login untuk melihat grafik' } },
            scales: { x: { display: true, title: { display: true, text: 'Usia (bulan)', font: { size: 14 } } }, y: { beginAtZero: true, title: { display: true, text: 'Nilai', font: { size: 14 } } } }
        }
      });
      return;
    }

    const users = getUsers();
    const data = (users[currentUser] && users[currentUser].data) ? users[currentUser].data.slice() : [];
    
    data.sort((a,b)=>a.usia - b.usia); 

    if(!data.length){
      chart = new Chart(ctx, {
        type: 'line',
        data: { labels: ['0'], datasets: [ { label: 'Tinggi (cm)', data: [0], borderColor: '#4f46e5', tension: 0.4 }, { label: 'Berat (kg)', data: [0], borderColor: '#ff8c42', tension: 0.4 } ] },
        options: { 
            responsive: true, 
            maintainAspectRatio: false, 
            plugins: { title: { display: true, text: 'Belum ada data pertumbuhan' } },
            scales: { x: { display: true, title: { display: true, text: 'Usia (bulan)', font: { size: 14 } } }, y: { beginAtZero: true, title: { display: true, text: 'Nilai', font: { size: 14 } } } }
        }
      });
      return;
    }

    const labels = data.map(d => String(d.usia));
    const tinggi = data.map(d => d.tinggi);
    const berat = data.map(d => d.berat);

    chart = new Chart(ctx, {
      type: 'line',
      data: {
        labels,
        datasets: [
          { 
            label: 'Tinggi (cm)', 
            data: tinggi, 
            borderColor: '#4f46e5', 
            backgroundColor: 'rgba(79,70,229,0.1)', 
            tension: 0.4, 
            fill: false,
            pointRadius: 6,
            pointHoverRadius: 8
          },
          { 
            label: 'Berat (kg)', 
            data: berat, 
            borderColor: '#ff8c42', 
            backgroundColor: 'rgba(255,140,66,0.1)', 
            tension: 0.4, 
            fill: false,
            pointRadius: 6,
            pointHoverRadius: 8
          }
        ]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            tooltip: { mode: 'index', intersect: false, bodyFont: { size: 14 }, titleFont: { size: 15 } },
            legend: { position: 'bottom', labels: { boxWidth: 12, font: { size: 14 } } }
        },
        scales: {
          x: {
              title: { display: true, text: 'Usia (bulan)', font: { size: 14, weight: 'bold' } }, ticks: { font: { size: 12 } }
          },
          y: { 
              beginAtZero: true,
              title: { display: true, text: 'Tinggi (cm) / Berat (kg)', font: { size: 14, weight: 'bold' } }, ticks: { font: { size: 12 } }
          }
        }
      }
    });
  }catch(err){
    console.error('renderChart error', err);
    showToast('Gagal memuat grafik. Cek konsol.', 'error');
  }
}

// --- INIT LISTENERS ---
function initListeners() {
    // 1. Automatic Age Calculation Listener
    document.getElementById('tanggalLahir').addEventListener('change', (e) => {
        const tglLahir = e.target.value;
        const usiaBulan = calculateAge(tglLahir);
        if (usiaBulan !== null) {
            document.getElementById('usia').value = usiaBulan;
            showToast(`Usia anak otomatis terisi: ${usiaBulan} bulan`, 'info');
        } else {
            document.getElementById('usia').value = '';
        }
    });
    
    // Sidebar Navigation:
    sidebarBtn.addEventListener('click', (e)=>{ e.stopPropagation(); if(sidebar.classList.contains('open')) closeSidebar(); else openSidebar(); });
    overlay.addEventListener('click', ()=>{ closeSidebar(); closeAuth(); closeImagePreview(); });
    document.addEventListener('click', (e)=>{ if(!sidebar.contains(e.target) && !sidebarBtn.contains(e.target) && sidebar.classList.contains('open')) closeSidebar(); });
    document.getElementById('openAuth').addEventListener('click', (e)=>{ e.preventDefault(); openAuth('login'); closeSidebar(); });
    
    // Auth Modal Switches:
    document.getElementById('showRegister').addEventListener('click', ()=> openAuth('register'));
    document.getElementById('showLogin').addEventListener('click', ()=> openAuth('login'));
    
    // Auth Actions:
    document.getElementById('btnRegister').addEventListener('click', ()=>{
      const u = document.getElementById('regUser').value.trim(); const p = document.getElementById('regPass').value; if(!u||!p){ showToast('Isi username & password', 'error'); return; }
      const users = getUsers(); if(users[u]){ showToast('Username sudah ada', 'error'); return; }
      users[u] = { password: p, data: [] }; saveUsers(users); showToast('Akun dibuat ‚Äî silakan login', 'success'); openAuth('login'); document.getElementById('regUser').value=''; document.getElementById('regPass').value='';
      renderAdminStats(); 
    });
    document.getElementById('btnLogin').addEventListener('click', ()=>{
      const u = document.getElementById('loginUser').value.trim(); const p = document.getElementById('loginPass').value; if(!u||!p){ showToast('Isi username & password', 'error'); return; }
      const users = getUsers(); 
      if(u==='admin' && p==='admin123'){ 
        currentUser='admin'; currentRole='admin'; closeAuth(); closeSidebar(); renderAuth(); renderList(); renderChart(); renderWho(); showToast('Login Admin berhasil', 'success'); return; 
      }
      if(!users[u] || users[u].password !== p){ showToast('Username / password salah', 'error'); return; }
      currentUser = u; currentRole = 'user'; closeAuth(); closeSidebar(); renderAuth(); renderList(); renderChart(); renderWho(); showToast('Login berhasil', 'success');
    });
    document.getElementById('btnLogout').addEventListener('click', ()=>{ currentUser=null; currentRole=null; renderAuth(); renderList(); renderChart(); renderWho(); showToast('Logout berhasil', 'info'); });
    
    // Admin Link Handler:
    document.getElementById('adminLink').addEventListener('click', (e)=>{
        e.preventDefault();
        if (currentRole === 'admin') {
            renderAdminStats();
            renderAuth(); 
            showToast('Menampilkan Dashboard Admin', 'info');
        }
    });
}

// initial load and setup
document.addEventListener('DOMContentLoaded', () => {
    initListeners();
    renderAuth(); 
    renderWho(); 
    renderList(); 
    renderChart();
});

// Ensure chart re-renders on resize 
window.addEventListener('resize', ()=> {
    setTimeout(renderChart, 100); 
});
</script>
</body>
  </html>
